<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/layout">
<head>
    <title>EMPLOYEES LIST</title>
</head>
<body layout:fragment="content">
<!-- Spinner Start -->
<div id="spinner"
     class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>
<!-- Spinner End -->
<div th:replace="fragments/sidebar :: sidebar"></div>
<div class="container-fluid position-relative d-flex p-0">

    <!-- Content Start -->
    <div class="content" style="
                    background-color: #e5e5f7;
                    opacity: 1;
                    background-image: radial-gradient(
                        #444cf7 0.6000000000000001px,
                        #e5e5f7 0.6000000000000001px
                    );
                    background-size: 12px 12px;
                ">
        <div th:replace="fragments/navigation :: navigation-without-search"></div>


        <div class="container-fluid">
            <div id="toolbar"
                 class="ms-3">
                <a href="" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">Add
                    Employee</a>
                <!--open modal to register employee account-->
            </div>
            <table
                    class="border border-primary"
                    id="table"
                    data-toggle="table"
                    data-toolbar="#toolbar"
                    data-toolbar-align="right"
                    data-search="true"
                    data-header-style="headerStyle"
                    data-url="/api/user/list"
                    data-pagination="true"
                    data-page-size="10"
                    data-page-list="[5, 10, 25, 50, 100, all]"
            >
                <thead class="thead-dark text-center text-white font-weight-bold text-uppercase bg-primary rounded shadow-sm p-3 mb-5">
                <tr>
                    <th data-sortable="true" data-formatter="indexFormatter" data-align="left" data-valign="middle"
                        data-width="100">No.
                    </th>
                    <th data-sortable="true" data-field="email" data-align="left" data-valign="middle" data-width="100">
                        Email
                    </th>
                    <th data-sortable="true" data-field="name" data-align="left" data-valign="middle" data-width="100">
                        Name
                    </th>
                    <th data-sortable="true" data-field="department" data-align="left" data-valign="middle"
                        data-width="100" data-formatter="departmentNameFormatter">Department
                    </th>
                    <th data-sortable="true" data-field="role" data-align="left" data-valign="middle" data-width="100">
                        Role
                    </th>
                    <th data-sortable="true" data-field="projectCount" data-align="left" data-valign="middle"
                        data-width="100" data-formatter="projectCountFormatter">Project Count
                    </th>
                </tr>
                </thead>

                <tbody>
                </tbody>


            </table>
        </div>
        <!--        <div th:replace="fragments/footer :: aside"></div>-->

        <!-- Register Employee Modal -->
        <div class="modal fade" id="addEmployeeModal" data-bs-backdrop="static" data-bs-keyboard="false"
             tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content ">
                    <div class="modal-header">
                        <h5 class="modal-title">Register Employee</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div><!-- Modal Header End -->
                    <div class="modal-body">

                        <!--alert message bootstrap-->
                        <div class="alert alert-success alert-dismissible fade show" role="alert" id="alert-success"
                             style="display: none">
                            <strong>Success!</strong> <span id="success-message"></span>
                            <button type="button" class="btn-close btn-dark" aria-label="close"
                                    style="background: transparent; position: absolute; top: 0; right: 0;">
                                &times;
                            </button>
                        </div>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert" id="alert-danger"
                             style="display: none">
                            <strong>Error!</strong> <span id="error-message"></span>
                            <button type="button" class="btn-close btn-dark" aria-label="close"
                                    style="background: transparent; position: absolute; top: 0; right: 0;">
                                &times;
                            </button>
                        </div>


                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="floatingText" placeholder="jhondoe" required>
                            <label for="floatingText">Username</label>
                        </div>


                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" id="floatingInput" placeholder="name@example.com"
                                   required>
                            <label for="floatingInput">Email address</label>
                        </div>

                        <div>
                            <select id="memberSelect" class="form-select form-select-lg mb-3"
                                    aria-label=".form-select-lg example" style="font-size: 16px;" required>
                                <option value="PROJECT_MANAGER" selected>Project Manager</option>
                                <option value="EMPLOYEE">Member</option>
                                <option value="FOC">FOC</option>
                                <option value="CONTRACT">Contract</option>
                            </select>
                        </div>

                        <div>
                            <select id="departmentSelect" class="form-select form-select-lg mb-3"
                                    aria-label=".form-select-lg example" style="font-size: 16px;">
                            </select>
                            <select id="projectManagerSelect" class="form-select form-select-lg mb-3"
                                    aria-label=".form-select-lg example" style="font-size: 16px;display: none">
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary py-3 w-100 mb-2" style="background-color: #369;"
                                id="register-employee-btn">Register
                        </button>
                    </div>  <!-- Modal Body End -->
                </div>
            </div>
        </div>
    </div>

</div>
<!-- Content End -->

</div>

<!--    for select drop-drown-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
<!-- fontawesome -->
<script src="/js/fontawesome.js"></script>
<!-- jquery -->
<script src="/js/jquery.3.7.1.min.js"></script>
<!-- bootstrap -->
<script src="/js/bootstrap.bundle.min.js"></script>
<!-- Template Javascript -->
<script src="/js/main.js"></script>
<script src="/js/forprogresscircleiguess.js"></script>

<!-- sort (department, project), form validation and search bar behavior are all here -->
<script src="/js/custome.js"></script>

<!-- Include Bootstrap Table, and Bootstrap Table Export JavaScript -->
<script src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>
<script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
<script>
    $(document).ready(function () {
        setupLogoutConfirmation();
    });

    function indexFormatter(value, row, index) {
        return index + 1;
    }

    function departmentNameFormatter(value, row, index) {
        if (value === null) {
            return '-';
        }
        return value.name;
    }

    function projectCountFormatter(value, row, index) {
        // 'value' may be undefined or empty initially
        // Replace 'userId' with the actual user ID
        const userId = row.id; // Assuming 'id' is the user ID property in your data

        //return something if user id not available
        if (userId === null) {
            return '';
        }

        // Make an AJAX request to fetch project count data
        $.ajax({
            url: '/api/project/count/user/' + userId,
            type: 'GET',
            async: false,
            success: function (data) {
                // 'data' is the response object from the AJAX request
                // 'data.projectCount' is the project count value
                console.log(data);
                value = data;
            },
            error: function (data) {
                // Handle the error response object
                console.log(data);
            }
        });

        // Return the project count value
        return value;
    }

    $(function () {

        $('#table').bootstrapTable({});

        $('.bootstrap-table').removeClass('bootstrap4').addClass('bootstrap5');

        function getDepartmentNameList() {
            var departmentNameList = [];
            $.ajax({
                url: '/api/department/list',
                type: 'GET',
                async: false,
                success: function (data) {
                    $.each(data, function (index, department) {
                        departmentNameList.push(department.name);
                    });
                }
            });
            return departmentNameList;
        }

        //initialize department list with department names
        var departmentNameList = getDepartmentNameList();
        $('#departmentSelect').empty();
        $.each(departmentNameList, function (index, departmentName) {
            $('#departmentSelect').append($('<option>', {
                value: departmentName.id,
                text: departmentName
            }));
        });


        $('#memberSelect').change(function () {
            var selectedValue = $(this).val();
            var departmentSelect = $('#departmentSelect');
            var projectManagerSelect = $('#projectManagerSelect');

            if (selectedValue === 'PROJECT_MANAGER') {
                // Show departmentSelect
                departmentSelect.show();

                // Hide projectManagerSelect and clear selected value
                projectManagerSelect.val('').trigger('change');
                projectManagerSelect.hide();


                // Make an AJAX request to populate departmentSelect options
                $.get('/api/department/list', function (data) {
                    departmentSelect.empty();
                    $.each(data, function (index, department) {
                        departmentSelect.append($('<option>', {
                            value: department.id,
                            text: department.name
                        }));
                    });
                });
            } else {
                // Show projectManagerSelect and hide departmentSelect
                projectManagerSelect.show();

                // Hide departmentSelect and clear selected value
                departmentSelect.val('').trigger('change');
                departmentSelect.hide();

                // Make an AJAX request to populate projectManagerSelect options
                $.get('/api/user/list/role/PROJECT_MANAGER', function (data) {
                    projectManagerSelect.empty();
                    $.each(data, function (index, user) {
                        projectManagerSelect.append($('<option>', {
                            value: user.id, // Adjust this based on your data
                            text: user.name // Adjust this based on your data
                        }));
                    });
                });
            }
        });

        //function show error with parameter message
        function showError(message) {
            $('#error-message').text(message);
            $('#alert-danger').show();

            setTimeout(function () {
                $('#alert-danger').hide();
            }, 1000);

            //close alert box
            $('.btn-close').click(function () {
                $('#alert-danger').hide();
            });
        }

        //function show success with parameter message
        function showSuccess(message) {
            $('#success-message').text(message);
            $('#alert-success').show();

            setTimeout(function () {
                $('#alert-success').hide();
            }, 1000);

            //close alert box
            $('.btn-close').click(function () {
                $('#alert-success').hide();
            });
        }


        $('#register-employee-btn').click(function () {
            var username = $('#floatingText').val();
            var email = $('#floatingInput').val();
            var role = $('#memberSelect').val();
            var departmentId = $('#departmentSelect').val();
            var projectManagerId = $('#projectManagerSelect').val();

            if (username === '' || email === '' || role === '' || departmentId === '' || projectManagerId === '') {
                showError("Please fill all the fields...")
                return;
            }

            console.log("department id : ",departmentId)
            console.log("pm id : ",projectManagerId)

            // Show a confirmation dialog using Swal
            Swal.fire({
                title: "Are you sure want to register this employee?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes"
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show the loading spinner on the button
                    $('#register-employee-btn').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Registering...');
                    $('#register-employee-btn').prop('disabled', true);

                    $.ajax({
                        url: '/api/user/register-employee',
                        type: 'POST',
                        data: JSON.stringify({
                            name: username,
                            email: email,
                            role: role,
                            departmentId: departmentId,
                            projectManagerId: projectManagerId
                        }),
                        contentType: 'application/json',
                        success: function (data) {
                            alert('Employee registered successfully');
                            $('#addEmployeeModal').modal('hide');
                            $('#register-employee-btn').html('Register').prop('disabled', false);
                            $('#table').bootstrapTable('refresh');
                            showSuccess('Employee registered successfully');
                        },
                        error: function (data, xhr) {
                            alert('Error registering employee');
                            $('#register-employee-btn').html('Register').prop('disabled', false);
                            $('#alert-danger').show();
                        },
                        complete: function () {

                        }
                    });
                }
            });
        });


    });


</script>
<script src="/js/notification.js" type="module"></script>
</body>
</html>