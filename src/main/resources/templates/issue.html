<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:layout="http://www.w3.org/1999/xhtml" layout:decorate="layout/layout"
      lang="en" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
<head>
    <style>

        .ql-toolbar {
            color: white;
        }

        .ql-editor {

        }

        [aria-expanded="true"] .fa-chevron-down {
            transform: rotate(180deg);
        }
    </style>
</head>

<body layout:fragment="content">

<!-- Spinner Start -->
<div id="spinner"
     class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="sr-only"></span>
    </div>
</div>
<!-- Spinner End -->

<div th:replace="fragments/sidebar :: sidebar"></div>
<div class="container-fluid position-relative d-flex p-0">

    

    <!-- Content Start -->
    <div class="content" style="
                    background-color: #e5e5f7;
                    opacity: 1;
                    background-image: radial-gradient(
                        #444cf7 0.6000000000000001px,
                        #e5e5f7 0.6000000000000001px
                    );
                    background-size: 12px 12px;
                ">

                

        <div th:replace="fragments/navigation :: navigation-without-search"></div>

        <div class="toast-container position-fixed p-3 end-0 bottom-0 " id="toasts-noti-container" style="z-index: 99;">
            <!-- Then put toasts within -->
            
            
        </div>

        <div
                class="container-fluid pt-2 ps-s pe-2"
                id="dropdrown-search-bar"
        >


            <div class="d-flex flex-row justify-content-between align-items-center">

                <nav class="">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                        <li class="breadcrumb-item active">Issue List</li>
                    </ol>
                </nav>

                <div>

                    <button class="btn btn-info" id="reset-btn" style="color: #ffffff !important;">
                    reset
                    </button>

                    <div class="d-inline-block">
                        <div class="d-inline-block">
                            <select id="status-filter" class="form-control">
                                <option value="" selected disabled>Status</option>
                                <option value="PENDING">PENDING</option>
                                <option value="APPROVE">APPROVE</option>
                                <option value="DECLINE">DECLINE</option>
                                <option value="DUPLICATE">DUPLICATE</option>
                            </select>
                        </div>
                        <div class="d-inline-block">
                            <select id="solved-filter" class="form-control">
                                <option value="" selected disabled>Choose</option>
                                <option value="1">Solved</option>
                                <option value="0">Unsolved</option>
                            </select>
                        </div>
                        <div class="d-inline-block">
                            <select id="category-filter" class="form-control">
                                <option value="" selected disabled>Category</option>
                                <option value="" disabled selected>Select Issue Category</option>
                                <option value="ERROR">Error</option>
                                <option value="BUG">Bug</option>
                                <option value="COMMUNICATION">Communication</option>
                                <option value="TECHNICAL">Technical</option>
                                <option value="BUDGET">Budget</option>
                                <option value="DESIGN">Design</option>
                                <option value="TESTING">Testing</option>
                                <option value="SCHEDULE_DELAYS">Schedule Delays</option>
                                <option value="DOCUMENTATION">Documentation</option>
                                <option value="SECURITY">Security</option>
                                <option value="OTHER">Other</option>
                            </select>
                        </div>
                        
                    <!-- modal toggle button start -->
                        <button type="button" class="btn d-none btn-light align-self-start" data-bs-toggle="modal"
                                data-bs-target="#add-issue">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    <!-- modal toggle button end -->
                    <!-- sortting button -->
                        <i class="bi bi-sort-alpha-down sort-btn text-dark"></i>

                    </div>
                </div>
                <!-- Modal -->
                
            </div>
            <div class="mt-2">
                <form class="">
                    <input
                        class="form-control border-0"
                        type="search"
                        placeholder="Search issue"
                    />
                </form>
            </div>
            

        <div class="container-fluid mt-2">
            <ul class="nav nav-tabs nav-tabs-bordered d-none" id="issue-link">
                <li class="nav-item">
                    <button
                            class="nav-link active"
                            data-bs-toggle="tab"
                            data-bs-target="#all-issue-list"
                    >
                        Issue List
                    </button>
                </li>

                <li class="nav-item">
                    <button
                            class="nav-link position-relative"
                            data-bs-toggle="tab"
                            data-bs-target="#unsolved-issues"
                    >
                        Unsolved Issues
                    </button>
                </li>
                <li class="nav-item">
                    <button
                            class="nav-link position-relative"
                            data-bs-toggle="tab"
                            data-bs-target="#new-issue-list-container"
                    >
                    <span
                            class="position-absolute d-none top-0 end-0 translate-middle bg-danger border border-light rounded-circle"
                            id="notification-light-for-new-issue"
                            style="padding: 7px;">
                    </span>
                        New Issues
                    </button>
                </li>
                <script type="module">

                    import {getUser} from "/js/currentLoginUser.js";

                    const user = await getUser();

                    if(user.currentUser.role === 'SDQC' || user.currentUser.role === 'PMO') {
                        document.querySelector("button[data-bs-target='#all-issue-list']").remove()
                        document.querySelector("button[data-bs-target='#unsolved-issues']").remove()
                        document.querySelector("button[data-bs-target='#new-issue-list-container']").remove()

                    }

                </script>
            </ul>
            <ul class="nav nav-tabs nav-tabs-bordered" id="issueTableNav" sec:authorize="hasAnyRole('PMO','SDQC')">
                <li class="nav-item">
                    <button
                            class="nav-link position-relative btn-light active"
                            data-bs-toggle="tab"
                            data-bs-target="#all-issue-list"
                    >
                        Feeds View
                        <i class="bi bi-rss"></i>
                    </button>
                </li>
                <li class="nav-item">
                    <button
                            class="nav-link position-relative btn-light"
                            data-bs-toggle="tab"
                            data-bs-target="#issue-table"
                    >
                        Table View
                        <i class="bi bi-table"></i>
                    </button>
                </li>
            </ul>


                <div class="tab-content pt-2">

                    <div class="tab-pane fade show active row row-cols-1 p-2" id="all-issue-list">
                        <div class="d-flex flex-column gap-2" id="sort-container"></div>
                        <div style="width: 100%; height:50vh" class="d-flex justify-content-center align-items-center d-none" id="no-result">
                            <div class="d-flex justify-content-center align-items-center flex-column">
                                <i class="bi bi-journal-x text-white" style="font-size: 6rem;"></i>
                                <h1 class="text-white">No Issue Found!</h1>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade show row row-cols-1" id="unsolved-issues">
                        <div class="d-flex flex-column gap-2" id="unsolved-issues-container">
                            
                        </div>
                    </div>

                    <div class="tab-pane fade show row row-cols-1" id="issue-table">
                        <div class="d-flex flex-column gap-2 d-none" id="issue-table-container">
                            <div id="toolbar" class="ms-3">
                                <div class="btn-group" role="group">
                                    <select class="form-control btn btn-primary" name="dropdown" id="exportSelect" style="width: 30%;">
                                        <option value="" selected disabled>Export PDF</option>
                                        <option value="all">Export All</option>
                                        <option value="selected">Export Selected</option>
                                    </select>
                                </div>

                                <div class="btn-group" role="group">
                                    <select class="form-control btn btn-primary" name="dropdown" id="exportExcelSelect" style="width: 30%;">
                                        <option value="" selected disabled>Export Excel</option>
                                        <option value="all">Export All</option>
                                        <option value="selected">Export Selected</option>
                                    </select>
                                </div>
                            </div>


                            <table
                                    class="border border-primary bg-white text-secondary"
                                    id="table"
                                    data-toggle="table"
                                    data-pagination="true"
                                    data-page-size="5"
                                    data-page-list="[5, 10, 20, 50, 100, 200]"
                                    data-sort-priority='[{"sortName": "project_name","sortOrder":"asc"},{"sortName":"title","sortOrder":"asc"}]'
                                    data-toolbar="#toolbar"
                                    data-toolbar-align="right"
                                    data-search="true"
                                    data-export-types="['csv', 'excel', 'pdf']"
                                    data-click-to-select="true"
                                    data-header-style="headerStyle"
                                    data-url="users"

                            >
                                <thead class="thead-dark text-center text-white font-weight-bold text-uppercase bg-primary rounded shadow-sm p-3 mb-5 border-white">
                                <tr>
                                    <th data-field="state" data-checkbox="true"></th>
                                    <th data-field="id" data-sortable="true">ID</th>
                                    <th data-field="title" data-sortable="true">Title</th>
                                    <th data-field="issue_category" data-sortable="true">Category</th>
                                    <th data-field="project_name" data-sortable="true">Project Name</th>
                                    <th data-field="place" data-sortable="true">Place
                                        <span style="visibility: hidden;">In this modification,</span>
                                    </th>
                                    <th data-field="impact" data-sortable="true">Impact
                                        <span style="visibility: hidden;">In this modification, </span>
                                    </th>
                                    <th data-field="root_cause" data-sortable="true">Root Cause
                                        <span style="visibility: hidden;">In this modification,</span></th>
                                    <th data-field="direct_cause" data-sortable="true">Direct Cause
                                        <span style="visibility: hidden;">In this modification,</span></th>
                                    <th data-field="corrective_action" data-sortable="true">Corrective Action
                                        <span style="visibility: hidden;">In this modification, </span></th>
                                    <th data-field="preventive_action" data-sortable="true">Preventive Action
                                        <span style="visibility: hidden;">In this modification, </span></th>
                                    <th data-field="responsible_party" data-sortable="true">Responsible Party</th>
                                    <th data-field="user_pic" data-sortable="true">Personal In Charge</th>
                                    <th data-field="status" data-sortable="true">Status</th>
                                    <th data-field="solved" data-sortable="true">Solved</th>
                                    <th data-field="created_date" data-sortable="true">Created Date</th>

                                </tr>
                                </thead>
                                <tbody>
                                <!-- Data will be dynamically loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade row row-cols-1" id="new-issue-list-container">
                        <div class="d-flex justify-content-between">
                            <div id="all-approval-input">
                                <input type="radio" id="all-duplicate" name="approval" value="DUPLICATE"
                                       class="all-approval-input"/>
                                <label for="all-duplicate">All Duplicate</label>
                                <input type="radio" id="all-approve" name="approval" value="APPROVE"
                                       class="all-approval-input"/>
                                <label for="all-approve">All Approve</label>
                                <input type="radio" id="all-decline" name="approval" value="DECLINE"
                                       class="all-approval-input"/>
                                <label for="all-decline">All Decline</label>
                            </div>
                            
                            <div>
                                <button type="button" class="btn btn-primary" id="all-approval-btn">Submit</button>
                            </div>
                        </div>
                        <div id="new-issue-list">
                        </div>
                        <div style="width: 100%; height:50vh" class="d-flex justify-content-center align-items-center d-none" id="no-new-issue">
                            <div class="d-flex justify-content-center align-items-center flex-column">
                                <i class="bi bi-journal-x text-white" style="font-size: 6rem;"></i>
                                <h1 class="text-white">No New Issue</h1>
                            </div>
                        </div>
                    </div>

            </div>
        </div>
    </div>
    <!-- Content End -->

    <!--    issue detail modal start-->
    <div class="modal fade" id="issueEditModal" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Issue Details</h4>
                    <div class="d-flex justify-content-center align-items-center gap-3">
                        <div class="btn btn-primary" id="issue-edit-btn">Mark as Resolve <i
                                class="fa-solid fa-check"></i></div>
                        <div class="btn btn-success" id="solve-btn">Solve <i class="fa-solid fa-check-double"></i></div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row row-cols-1 row-cols-sm-1 row-cols-md-1 row-cols-lg-1 row-cols-xl-1 row-cols-xxl-1 gap-2">
                            <div class="alert alert-danger alert-dismissible" id="errorAlert" style="display: none;">
                                <strong>Error : </strong> <span id="errorText"></span>
                                <button type="button" class="btn-close btn-dark" aria-label="close"
                                        style="background: transparent; position: absolute; top: 0; right: 0;">
                                    &times;
                                </button>
                            </div>
                            <div class="alert alert-success alert-dismissible" id="successAlert" style="display: none;">
                                <strong>Success : </strong> <span id="successText"></span>
                                <button type="button" class="btn-close btn-dark" aria-label="close"
                                        style="background: transparent; position: absolute; top: 0; right: 0;">
                                    &times;
                                </button>
                            </div>
                            <div class="col mb-3">
                                <input type="hidden" id="solved"/>
                                <h5 class="icon-title"><i class="fas fa-wrench text-dark"></i> Corrective Action</h5>
                                <textarea id="corrective_actionInput" class="form-control form-control-sm btn-space"
                                          name="corrective_action" rows="5"></textarea>

                            </div>
                            <div class="col mb-3">
                                <h5 class="icon-title"><i class="fas fa-shield-alt text-dark"></i>Preventive Action</h5>
                                <textarea id="preventive_actionInput" class="form-control form-control-sm btn-space"
                                          name="preventive_action" rows="5"></textarea>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- add issue modal start -->
<div class="modal fade bd-example-modal-lg" id="add-issue" data-bs-keyboard="true">
    <div class="modal-dialog modal-lg">

        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Create New Issue</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <!-- issue modal start -->
                <div class="row g-3 " id="addIssueValidationForm">
                    <div class="alert alert-danger alert-dismissible" id="error-alert" style="display: none;">
                        <strong>Error : </strong> <span id="error-text"></span>
                        <button type="button" class="btn-close btn-dark" aria-label="close"
                                style="background: transparent; position: absolute; top: 0; right: 0;">
                            &times;
                        </button>
                    </div>
                    <div class="alert alert-success alert-dismissible" id="success-alert" style="display: none;">
                        <strong>Success : </strong> <span id="success-text"></span>
                        <button type="button" class="btn-close btn-dark" aria-label="close"
                                style="background: transparent; position: absolute; top: 0; right: 0;">
                            &times;
                        </button>
                    </div>
                    <div class="col-lg-6">
                        <label for="title" class="col-sm-12 col-form-label" name="title">Issue Title<span
                                style="color:#e86666"> *</span></label>
                        <input type="text" class="form-control border-task-description" id="title" name="title"
                               placeholder="Title">
                    </div>

                    <div class="col-lg-6">
                        <label for="issue_category" class="col-sm-12 col-form-label" name="issueCategory">Issue Category<span
                                style="color:red"> *</span></label>
                        <select class="form-select border-task-description" name="issue_category" id="issue_category">
                            <option value="" disabled selected>Select Issue Category</option>
                            <option value="ERROR">Error</option>
                            <option value="BUG">Bug</option>
                            <option value="COMMUNICATION">Communication</option>
                            <option value="TECHNICAL">Technical</option>
                            <option value="BUDGET">Budget</option>
                            <option value="DESIGN">Design</option>
                            <option value="TESTING">Testing</option>
                            <option value="SCHEDULE_DELAYS">Schedule Delays</option>
                            <option value="DOCUMENTATION">Documentation</option>
                            <option value="SECURITY">Security</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>


                    <div class="col-lg-6">
                        <label for="user_pic" class="col-sm-12 col-form-label" name="user_pic">Person In Charge <span
                                style="color:red"> *</span></label>
                        <select class="form-select border-task-description" data-live-search="true"
                                aria-label="Select PIC" id="user_pic" name="user_pic" disabled>

                        </select>
                    </div>


                    <div class="col-lg-6">
                        <div class="form-check-inline">
                            <span><label for="responsible_party" class="col-sm-12 col-form-label"
                                         name="responsible_type">Responsible Party <span
                                    style="color:red"> *</span>  <input class="form-check-input " type="checkbox"
                                                                        id="responsible_type" name="client_checkbox"
                                                                        value="CLIENT"
                                                                        style="margin-left:130px;"> <label
                                    class="form-check-label">Client</label></label>
                             </span>
                        </div>

                        <select class="form-select border-task-description" aria-label="Select Responsible Party"
                                id="responsible_party" name="responsible_party"></select>

                    </div>

                    <div class="col-lg-12" style="margin-bottom: 80px;">
                        <label for="description" class="col-sm-12 col-form-label" name="name">Description<span
                                style="color:#e86666"> *</span></label>
                        <div class="quill-editor-bubble" id="description" name="description" required
                             pattern=".*\S.*"></div>

                        <div id="objectiveError" class="invalid-feedback"></div>

                    </div>

                    <div class="col-lg-6">
                        <label for="direct_cause" class="col-sm-12 col-form-label" name="direct_cause">Direct Cause<span
                                style="color:#e86666"> *</span></label>

                        <textarea class="form-control border-task-description" id="direct_cause"
                                  name="direct_cause"></textarea>
                    </div>

                    <div class="col-lg-6">
                        <label for="root_cause" class="col-sm-12 col-form-label" name="root_cause">Root Cause<span
                                style="color:#e86666"> *</span></label>
                        <textarea class="form-control border-task-description" id="root_cause"></textarea>
                    </div>

                    <div class="col-lg-6">
                        <label for="place" class="col-sm-12 col-form-label" name="place">Place<span
                                style="color:#e86666"> *</span></label>
                        <textarea class="form-control border-task-description" id="place" name="place"></textarea>
                    </div>

                    <div class="col-lg-6">
                        <label for="impact" class="col-sm-12 col-form-label" name="impact">Impact<span
                                style="color:#e86666"> *</span></label>
                        <textarea class="form-control border-task-description" id="impact" name="impact"></textarea>
                    </div>

                    <div class="w-25 m-auto d-flex justify-content-center align-items-center gap-2 mt-2">
                        <button type="button" id="addIssue" class="btn btn-primary" >Add Issue</button>

                    </div>

                </div>
                <!-- issue modal end -->

            </div>
        </div>
    </div>
</div>
<!-- add issue modal end -->





<script>
    function rotateIcon(element) {
        // Get the icon element
        const icon = element.querySelector('.rotate-icon');

        // Toggle the 'rotate' class to apply or remove rotation
        icon.classList.toggle('rotate');
    }
</script>


<!--    issue detail modal start-->
<div class="modal fade issueDetails" id="issueDetailsModal" tabindex="-1" aria-labelledby="staticBackdropLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Issue Details</h4>
                <div class="d-flex justify-content-end align-items-center gap-2">
                   <h6 class="fw-bold">Created at</h6>
                    <span id="solveDateDetails" class="py-1 px-2 rounded bg-primary text-white"></span>
                </div>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row row-cols-1 row-cols-sm-1 row-cols-md-1 row-cols-lg-1 row-cols-xl-1 row-cols-xxl-1 gap-2">

                        <!-- <h6 data-toggle="collapse" href="#peoples" onclick="rotateIcon(this)"><i class="fas fa-chevron-circle-down rotate-icon"></i> People</h6> -->
                        <div id="peoples" class="row row-cols-2">
                            <div class="col mb-3 ">
                                <div>
                                    <div>
                                        <i class="fa-solid fa-user-pen"></i>
                                        <span class="fw-bold">Person In Charge</span>
                                    </div>
                                </div>
                                <div class="d-flex mt-3"><div style="width:22px;"></div><span class="py-1 px-2 text-center bg-primary text-white rounded " id="picDetails"></span></div>

                            </div>
                            <div class="col mb-3 ">
                                <div>
                                    <div>
                                        <i class="fa-solid fa-users-gear"></i>
                                        <span class="fw-bold">Responsible Party</span>
                                    </div>
                                </div>
                                <div class="d-flex mt-3"><div style="width:22px;"></div><span class="py-1 px-2 text-center bg-primary text-white rounded " id="rpDetails"></span></div>
                            </div>
                        </div>

                        <!-- <h6 data-toggle="collapse" href="#solution-detail" onclick="rotateIcon(this)"><i class="fas fa-chevron-circle-down rotate-icon"></i>  Solution</h6> -->

                        <!-- <h6 data-toggle="collapse" href="#details" onclick="rotateIcon(this)"><i class="fas fa-chevron-circle-down rotate-icon"></i>  Details</h6> -->
                        
                        <div id="issue-detail-description" class="">
                            <div>
                                <div>
                                    <i class="fa-solid fa-minus"></i>
                                    <span class="fw-bold ">Description</span>
                                </div>
                            </div>
                            <div class="accordion-body border-top" id="descriptionDetails"></div>

                        </div>
                        <div class="col mb-3 d-none" id="issue-description-save-btn-container">
                            <button class="btn btn-success" id="issue-description-save-btn">Save</button>
                        </div>
                        
                        <div id="details" class="border-top border-bottom pt-1">
                            
                            <div class="mb-3s">
                                <div class="text-center">
                                    <h3 class="fw-bold">Details</h3>
                                </div>
                            </div>
                            <div class="row row-cols-2">
                                <div class=" mb-3">

                                    <label for="issueTitleDetails" class="fw-bold">Title:</label>
                                    <input type="text" class="form-control" id="issueTitleDetails"/>

                                </div>
                                <div class=" mb-3 ">
                                    <label for="issue_categoryDetails" class="fw-bold">Category:</label>
                                    <select id="issue_categoryDetails" class="form-control me-2">
                                        <option value="ERROR">ERROR</option>
                                        <option value="BUG">BUG</option>
                                        <option value="COMMUNICATION">COMMUNICATION</option>
                                        <option value="TECHNICAL">TECHNICAL</option>
                                        <option value="BUDGET">BUDGET</option>
                                        <option value="DESIGN">DESIGN</option>
                                        <option value="TESTING">TESTING</option>
                                    </select>
                                </div>
                            </div>

                                <div class="col mb-3 ">
                                    <label for="direct_causeDetails" class=" fw-bold">Direct Cause:</label>
                                    <textarea class="form-control" id="direct_causeDetails"></textarea>

                                </div>

                                <div class="col mb-3">
                                    <label for="root_causeDetails" class=" fw-bold">Root Cause:</label>
                                    <textarea class="form-control" id="root_causeDetails"></textarea>

                                </div>

                                <div class="col mb-3 ">
                                    <label for="placeDetails" class=" fw-bold">Place:</label>
                                    <textarea class="form-control" id="placeDetails"></textarea>

                                </div>

                                <div class="col mb-3 ">

                                    <label for="impactDetails" class="fw-bold">Impact:</label>
                                    <textarea class="form-control" id="impactDetails"></textarea>

                            </div>

                            <div class="col mb-3 d-none" id="issue-detail-save-btn-container">
                                <button class="btn btn-success" id="issue-detail-save-btn">Save</button>
                            </div>
                        </div>

                        <div id="solution-detail" class="">
                            <div>
                                <div class="d-flex gap-2">
                                    <i class="fa-brands fa-rocketchat text-warning fs-3"></i>
                                    <h3 >Solution</h3>
                                </div>
                            </div>
                            <div class="col mb-3 mt-4">
                                <div>
                                    <i class="fa-solid fa-screwdriver-wrench text-success"></i>
                                    <span>Corrective Action</span>
                                </div>
                                <p class="mt-3" id="correctiveDetails"></p>

                            </div>
                            <hr>
                            <div class="col mb-3 mt-4">
                                <div>
                                    <i class="fa-solid fa-shield text-success"></i>
                                    <span>Preventive Action</span>
                                </div>
                                <p class="mt-3" id="preventiveDetails"></p>

                            </div>
                        </div>

                        <!-- <h6 data-toggle="collapse" href="#issue-detail-description" onclick="rotateIcon(this)"><i class="fas fa-chevron-circle-down rotate-icon"></i>Description</h6> -->
                        
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
</div>

<div class="modal fade" id="alert-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="alert alert-success text-center" role="alert" id="alert-text">

        </div>
    </div>
</div>

<!--    for select drop-drown-->
<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>-->

<!-- fontawesome -->
<script src="/js/fontawesome.js"></script>

<!-- jquery -->
<script src="/js/jquery.3.7.1.min.js"></script>


<!-- datable table -->
<script src="/js/databales.min.js"></script>

<!-- bootstrap -->
<script src="/js/bootstrap.bundle.min.js"></script>

<!-- javascript libraries -->
<script src="/lib/chart/chart.min.js"></script>
<script src="/lib/quill/quill.min.js"></script>

<!-- Template Javascript -->
<script src="/js/main.js"></script>

<!-- sort (department, project), form validation and search bar behavior are all here -->
<script src="/js/custome.js"></script>

<script src="/js/currentLoginUser.js" type="module" async></script>
<script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>

<script src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.15.5/dist/sweetalert2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@10.15.5/dist/sweetalert2.min.css" rel="stylesheet">

<script type="module">


    $(document).ready(function () {
        setupLogoutConfirmation();
    });

    $(document).ready(function () {

        const issueDetialEdit = document.querySelector("#details")

        const saveButton = issueDetialEdit.querySelector("#issue-detail-save-btn-container")

        saveButton.addEventListener("click", function (e) {
            console.log("this suck")

            const issueId = issueDetialEdit.getAttribute("data-currentEditingIssueId")
            const issueTitle = issueDetialEdit.querySelector("#issueTitleDetails").value
            const issueCategory = issueDetialEdit.querySelector("#issue_categoryDetails").value
            const directCause = issueDetialEdit.querySelector("#direct_causeDetails").value
            const rootCause = issueDetialEdit.querySelector("#root_causeDetails").value
            const place = issueDetialEdit.querySelector("#placeDetails").value
            const impact = issueDetialEdit.querySelector("#impactDetails").value

            const issue = {
                id: issueId,
                title: issueTitle,
                issueCategory: issueCategory,
                direct_cause: directCause,
                root_cause: rootCause,
                place: place,
                impact: impact,
                updated_date: Date.now()
            }

            console.log(issueTitle, issueCategory, directCause, rootCause, place, impact, issueId)

            $.ajax({
                url: `/api/issue/update/${issueId}`, // Replace with your actual URL
                type: 'PUT', // Change to 'PUT' or 'PATCH' if needed
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(issue),
                success: function (response) {
                    console.log('Ajax request successful:', response);
                    // Handle success response
                    saveButton.classList.add('d-none')

                    const issue = createIssueCard(response);

                    const oldIssue = $(`#issue-${response.id}`)

                    oldIssue.replaceWith(issue)

                    $("#alert-text").text(
                        "Issue Updaed Successfully"
                    );
                    $("#alert-modal").modal("show");

                },
                error: function (xhr, status, error) {
                    console.log('Ajax request error:', error);
                    // Handle error response
                }
            });

        })

        issueDetialEdit.addEventListener("input", function (e) {
            console.log("this suck")


            if (saveButton.classList.contains("d-none")) {
                saveButton.classList.remove("d-none")
            }

        })
        setupLogoutConfirmation();
    });

    document.querySelectorAll("button[data-bs-target=\"#all-issue-list\"]").forEach(button =>
        
        {
            button.addEventListener("show.bs.tab", async function (e) {

            const issueListContainer = document.querySelector("#sort-container")

            const issueList = await getData('/api/issue/list')

            issueListContainer.innerHTML = ''

            for (let i = issueList.length - 1; i >= 0; i--) {

                issueListContainer.appendChild(createIssueCard(issueList[i]));
            }

        })
    })

    $("button[data-bs-target=\"#issue-table\"]").on("show.bs.tab",function (e) {
        $("#issue-table-container").removeClass("d-none");
    })

    if(document.querySelector("button[data-bs-target=\"#unsolved-issues\"]")) {

        document.querySelector("button[data-bs-target=\"#unsolved-issues\"]").addEventListener("show.bs.tab", async function (e) {

            const unsolvedIssueListContainer = document.querySelector("#unsolved-issues-container")

            const unsolvedIssueList = await getData(`/api/issue/list/unsolved/${getLoginUser.currentUser.id}`)

            for (let i = unsolvedIssueList.length - 1; i >= 0; i--) {

                unsolvedIssueListContainer.appendChild(createIssueCard(unsolvedIssueList[i]));

            }

        })

        // Author: Habib Mhamadi
        // Email: habibmhamadi@gmail.comd
        function getTimeAgo(timestamp) {
            const date = new Date(timestamp);
            const currentDate = new Date();
            const timeDifference = currentDate - date;
            const seconds = Math.floor(timeDifference / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days < 1) {
                if (hours < 1) {
                    if (minutes < 1) {
                        return "Just now";
                    } else {
                        return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                    }
                } else {
                    return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                }
            } else if (days < 30) {
                return `${days} day${days > 1 ? 's' : ''} ago`;
            } else {
                const months = Math.floor(days / 30);
                return `${months} month${months > 1 ? 's' : ''} ago`;
            }
        }
    }

    import {getUser} from "/js/currentLoginUser.js";
    import {formatDate,getTimeElapsed} from "/js/time.js";
    import {getData} from "/js/api-function.js";

    console.log(await getUser());
    let quillEditors = document.querySelectorAll(
        ".quill-editor-bubble"
    );
    let toolbaroptions = [
        // Test-style
        ["bold", "italic", "underline"],

        // Bullet points style...
        [{list: "ordered"}, {list: "bullet"}],

        // Sub and super script...
        [{script: "sub"}, {script: "super"}],

        // Indentation...
        [{indent: "+1"}, {indent: "-1"}],

        // Alignment
        [{align: []}],

        // Header for test, e.g., h1, h2...
        [{header: [1, 2, 3, 4, 5, 6, false]}],

        // Adding image, link, video, or formula
        ["link"],

        // Adding code snippet or blockquote
        ["code-block", "blockquote"],
    ];
    // If you want to initialize Quill for a specific element, you can do it like this:
    let getLoginUser = await getUser();
    console.log("current login user ", getLoginUser)
    let data = [];
    const currentLoginUserRole = getLoginUser.currentUser.role;

    console.log(currentLoginUserRole)
    console.log(currentLoginUserRole === "FOC")

    if (currentLoginUserRole === 'PROJECT_MANAGER' || currentLoginUserRole === 'SDQC' || currentLoginUserRole === 'PMO') {
        document.querySelector("#issue-link").classList.remove("d-none")
    }

    // const currentUser = await getUser();
    const dataForIssue = await getData(`/api/project/list/ID/${getLoginUser.currentUser.id}/false`)
    console.log("dataForIssue", dataForIssue);
    $(document).ready(async function () {


        if (currentLoginUserRole === 'EMPLOYEE' || currentLoginUserRole === 'FOC' || currentLoginUserRole === 'CONTRACT') {
            $.get(`api/project/list/ID/${getLoginUser.currentUser.id}/IN_PROGRESS`, function (userData) {
                data = userData; // Set the data array with the retrieved user data
                console.log("User Data: " + JSON.stringify(data));
                const user_pic = $('#user_pic');

                user_pic.append($('<option>', {
                    value: getLoginUser.currentUser.projectManager.id,
                    text: getLoginUser.currentUser.projectManager.name,
                    data: {picUrl: getLoginUser.currentUser.projectManager.picUrl},

                    user: getLoginUser.currentUser.projectManager,
                }));
            });

            let clientData = await getData(`/api/project/list/ID/${getLoginUser.currentUser.id}/IN_PROGRESS`);

            console.log(clientData)


            function populateClientName() {
                const responsiblePartySelect = $('#responsible_party');
                responsiblePartySelect.empty();
                responsiblePartySelect.append($('<option>', {
                    value: `client_${clientData.client.id}`,
                    text: `${clientData.client.name}`,
                }));
            }

// Function to populate the responsible party select box with user names
            function populateUserNames() {
                const responsiblePartySelect = $('#responsible_party');
                responsiblePartySelect.empty();

                responsiblePartySelect.append($('<option>', {
                    text: 'Select Responsible Party',
                }));

                if (clientData.userList) {
                    clientData.userList.forEach(user => {
                        responsiblePartySelect.append($('<option>', {
                            value: `user_${user.id}`,
                            text: `${user.name}`,
                            data: {picUrl: user.picUrl},
                            user: user,
                        }));
                    });
                }
            }

// Fetch client data and populate the select box initially
            $.get(`api/project/list/ID/${getLoginUser.currentUser.id}/false`, function (data) {
                clientData = data;
                console.log("Client Data: " + JSON.stringify(clientData));
                // Check the "Client" checkbox initially
                if(typeof clientData === 'object' && clientData !== null) {
                    $('#responsible_type').prop('checked', true);
                    populateClientName();
                    document.querySelector("button[data-bs-target='#add-issue']").classList.remove('d-none')
                } else {
                    document.querySelector("button[data-bs-target='#add-issue']").classList.add('d-none')
                }
            });
            let actual_responsible_type = 'CLIENT';

// Event handler for the "Client" checkbox
            $('#responsible_type').on('change', function () {
                const isChecked = $(this).is(':checked');

                if (isChecked) {
                    // If the "Client" checkbox is checked, show only the client's name
                    populateClientName();
                    actual_responsible_type = 'CLIENT'
                } else {
                    // If the "Client" checkbox is not checked, show user names
                    populateUserNames();
                    actual_responsible_type = 'EMPLOYEE'
                }
            });


            // validation For Issue

            let validatedForm = false;

            function validateTitle() {
                const title = $('#title').val();
                const errorContainer = $('#title').siblings('.error-container');
                if (title.length < 1) {
                    validatedForm = false;
                    if (errorContainer.length === 0) {
                        let p = $("<p>")
                            .addClass("text-danger fs-6")
                            .text("Title is required")
                            .css("margin", "0")
                            .addClass('error-message');

                        $('#title').after('<div class="error-container"></div>');
                        $('#title').siblings('.error-container').append(p);
                    }

                    $('#title').addClass('is-invalid');
                    $('#title').removeClass('is-valid');
                } else {
                    validatedForm = true;
                    errorContainer.remove();
                    $('#title').addClass('is-valid');
                    $('#title').removeClass('is-invalid');
                }
            }


            let descriptionEditor;

            function initializeQuillEditor() {
                descriptionEditor = new Quill('.quill-editor-bubble', {
                    modules: {
                        toolbar: toolbaroptions
                    },
                    theme: 'snow'
                });

            }

            function validateDescription() {
                if (!descriptionEditor) {
                    console.error("Quill editor not initialized");
                    return;
                }

                const description = descriptionEditor.getText().trim();
                const errorContainer = $('.quill-editor-bubble').siblings('.error-container');

                if (!description || description.length === 0) {
                    validatedForm = false;
                    console.log("Objective error");

                    if (errorContainer.length === 0) {
                        let p = $("<p>")
                            .addClass("text-danger fs-6")
                            .text("Description is required")
                            .css("margin", "0")
                            .addClass('error-message');

                        $('.quill-editor-bubble').after('<div class="error-container"></div>').siblings('.error-container').append(p);
                    } else {
                        errorContainer.show();
                    }

                    $('.quill-editor-bubble').addClass('is-invalid');
                    $('.quill-editor-bubble').removeClass('is-valid');
                } else {
                    console.log("Objective success");
                    validatedForm = true;

                    if (errorContainer.length > 0) {
                        errorContainer.hide();
                    }

                    $('.quill-editor-bubble').addClass('is-valid');
                    $('.quill-editor-bubble').removeClass('is-invalid');
                }
            }

            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                initializeQuillEditor();
            } else {

                document.addEventListener('DOMContentLoaded', initializeQuillEditor);
            }

            let validationPerformed = false;


            function validatePlace() {
                const place = $('#place').val();
                const errorContainer = $('#place').siblings('.error-container');
                if (place.length < 1) {
                    validatedForm = false;
                    if (errorContainer.length === 0) {
                        let p = $("<p>")
                            .addClass("text-danger fs-6")
                            .text(
                                "Place is required"
                            )
                            .css("margin", "0");

                        $('#place').after('<div class="error-container"></div>');
                        $('#place').siblings('.error-container').append(p);
                    }
                    $('#place').addClass('is-invalid');
                    $('#place').removeClass('is-valid');
                } else {
                    validatedForm = true;
                    errorContainer.remove();
                    $('#place').addClass('is-valid');
                    $('#place').removeClass('is-invalid');
                }
            }

            function validateImpact() {
                const impact = $('#impact').val();
                const errorContainer = $('#impact').siblings('.error-container');
                if (impact.length < 1) {
                    validatedForm = false;
                    if (errorContainer.length === 0) {
                        let p = $("<p>")
                            .addClass("text-danger fs-6")
                            .text(
                                "Impact is required"
                            )
                            .css("margin", "0");
                        $('#impact').after('<div class="error-container"></div>');
                        $('#impact').siblings('.error-container').append(p);
                    }

                    $('#impact').addClass('is-invalid');
                    $('#impact').removeClass('is-valid');
                } else {
                    validatedForm = true;
                    errorContainer.remove();
                    $('#impact').addClass('is-valid');
                    $('#impact').removeClass('is-invalid');
                }
            }

            function validateRootCause() {
                const rootCause = $('#root_cause').val();
                const errorContainer = $('#root_cause').siblings('.error-container');
                if (rootCause.length < 1) {
                    validatedForm = false;
                    if (errorContainer.length === 0) {
                        let p = $("<p>")
                            .addClass("text-danger fs-6")
                            .text(
                                "Root Cause is required"
                            )
                            .css("margin", "0");
                        $('#root_cause').after('<div class="error-container"></div>');
                        $('#root_cause').siblings('.error-container').append(p);
                    }

                    $('#root_cause').addClass('is-invalid');
                    $('#root_cause').removeClass('is-valid');
                } else {
                    validatedForm = true;
                    errorContainer.remove();
                    $('#root_cause').addClass('is-valid');
                    $('#root_cause').removeClass('is-invalid');
                }
            }

            function validateDirectCause() {
                const directCause = $('#direct_cause').val();
                const errorContainer = $('#direct_cause').siblings('.error-container');
                if (directCause.length < 1) {
                    validatedForm = false;
                    if (errorContainer.length === 0) {
                        let p = $("<p>")
                            .addClass("text-danger fs-6")
                            .text(
                                "Direct Cause is required"
                            )
                            .css("margin", "0");
                        $('#direct_cause').after('<div class="error-container"></div>');
                        $('#direct_cause').siblings('.error-container').append(p);
                    }


                    $('#direct_cause').addClass('is-invalid');
                    $('#direct_cause').removeClass('is-valid');
                } else {
                    validatedForm = true;
                    errorContainer.remove();
                    $('#direct_cause').addClass('is-valid');
                    $('#direct_cause').removeClass('is-invalid');
                }
            }

            function validateIssueCategory() {
                const issueCategory = $('#issue_category').val();
                const errorContainer = $('#issue_category').siblings('.error-container');

                if (!issueCategory || issueCategory === "") {

                    validatedForm = false;
                    if (errorContainer.length === 0) {
                        let p = $("<p>")
                            .addClass("text-danger fs-6")
                            .text(
                                "Issue Category is required"
                            )
                            .css("margin", "0");
                        $('#issue_category').after('<div class="error-container"></div>');
                        $('#issue_category').siblings('.error-container').append(p);
                    }

                    $('#issue_category').addClass('is-invalid');
                    $('#issue_category').removeClass('is-valid');
                } else {
                    validatedForm = true;
                    errorContainer.remove();
                    $('#issue_category').addClass('is-valid');
                    $('#issue_category').removeClass('is-invalid');
                }
            }

            function validateResponsibleParty() {
                const responsibleParty = $('#responsible_party').val();
                const errorContainer = $('#responsible_party').siblings('.error-container');
                if (!responsibleParty || responsibleParty === "") {
                    validatedForm = false;
                    if (errorContainer.length === 0) {
                        let p = $("<p>")
                            .addClass("text-danger fs-6")
                            .text(
                                "Responsible Party is required"
                            )
                            .css("margin", "0");
                        $('#responsibleParty').after('<div class="error-container"></div>');
                        $('#responsibleParty').siblings('.error-container').append(p);
                    }
                    $('#responsibleParty').addClass('is-invalid');
                    $('#responsibleParty').removeClass('is-valid');
                } else {
                    validatedForm = true;
                    errorContainer.remove();
                    $('#responsibleParty').addClass('is-valid');
                    $('#responsibleParty').removeClass('is-invalid');
                }
            }

            function validateUserPic() {
                const userPic = $('#user_pic').val();
                const errorContainer = $('#user_pic').siblings('.error-container');
                if (!userPic || userPic === "") {
                    validatedForm = false;
                    if (errorContainer.length === 0) {
                        let p = $("<p>")
                            .addClass("text-danger fs-6")
                            .text(
                                "Person In Charge is required"
                            )
                            .css("margin", "0");
                        $('#user_pic').after('<div class="error-container"></div>');
                        $('#user_pic').siblings('.error-container').append(p);
                    }
                    $('#user_pic').addClass('is-invalid');
                    $('#user_pic').removeClass('is-valid');
                } else {
                    validatedForm = true;
                    errorContainer.remove();
                    $('#user_pic').addClass('is-valid');
                    $('#user_pic').removeClass('is-invalid');
                }
            }

            function validateIssue() {
                validateTitle();
                validateDescription();
                validatePlace();
                validateImpact();
                validateRootCause();
                validateDirectCause();
                validateIssueCategory();
                validateResponsibleParty();
                validateUserPic();
                return validatedForm;

            }

            $('#title').on('input', function () {
                validateTitle();
            });

            $('.quill-editor-bubble').on('input', function () {
                validateDescription();
            });

            $('#place').on('input', function () {
                validatePlace();
            });

            $('#impact').on('input', function () {
                validateImpact();
            });

            $('#root_cause').on('input', function () {
                validateRootCause();
            });

            $('#direct_cause').on('input', function () {
                validateDirectCause();
            });

            $('#issue_category').on('change', function () {
                validateIssueCategory();
            });

            $('#responsible_party').on('change', function () {
                validateResponsibleParty();
            });

            $('#user_pic').on('change', function () {
                validateUserPic();
            });

            if(dataForIssue !== null) {
            //for add issue
            $('#addIssue').on('click', async function () {
                const title = $('#title').val();
                const description = descriptionEditor.root.innerHTML;
                const place = $('#place').val();
                const impact = $('#impact').val();
                const root_cause = $('#root_cause').val();
                const direct_cause = $('#direct_cause').val();
                const responsible_party = $('#responsible_party').val();
                const issue_category = $('#issue_category').val();
                console.log(issue_category)
                const responsible_type = actual_responsible_type;
                const selectedUserId = $('#user_pic').val();
                const issueId = $('#issue-edit-btn').data('issueId');

                if (!validateIssue()) {
                    showerror('Please fill in all the required fields.');
                    return;
                }

                const selectedResponsibleParty = parseInt(responsible_party.split("_")[1])
                const uploaderId = getLoginUser.currentUser.id;
                console.log("Uploader Id", uploaderId);

                const requestData = {
                    title: title,
                    description: description,
                    place: place,
                    impact: impact,
                    created_date: new Date().getTime(),
                    updated_date: new Date().getTime(),
                    root_cause: root_cause,
                    direct_cause: direct_cause,
                    responsible_party: selectedResponsibleParty,
                    issueCategory: issue_category,
                    responsible_type: responsible_type,
                    project_id: dataForIssue.projectId,
                    user_uploader: uploaderId,
                    user_pic: selectedUserId,


                };

                console.log('Request Data:', requestData);

                $.ajax({
                    url: '/api/issue/save',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    dataType: 'json',
                    success: function (data) {
                        console.log(data);
                        $("#alert-text").text(
                            "Issue Created Successfully"
                        );
                        $("#alert-modal").modal("show");

                        const title = $('#title').val('');
                        const description = descriptionEditor.root.innerHTML = '';
                        const place = $('#place').val('');
                        const impact = $('#impact').val('');
                        const root_cause = $('#root_cause').val('');
                        const direct_cause = $('#direct_cause').val('');

                        $("#add-issue").modal("hide")

                        // $('#title').val('');
                        // $('#description').val('');
                        // $('#place').val('');
                        // $('#impact').val('');
                        // $('#root_cause').val('');
                        // $('#direct_cause').val('');
                        // $('#responsible_party').val('');
                        // $('#issue_category').val('');
                        // $('#user_pic').val('');
                        // $('#responsible_type').val('');




                    },
                    error: function (xhr, status, error) {
                        console.log('Status:', status);
                        console.log('Error:', error);
                        console.log('Server response:', xhr.responseText);

                        if (xhr.getResponseHeader('Content-Type') === 'application/json') {
                            // Handle JSON response
                            try {
                                const response = JSON.parse(xhr.responseText);
                                console.log('JSON Response:', response);
                            } catch (e) {
                                console.log('JSON parsing error:', e);
                            }
                        } else {
                            // Handle non-JSON response
                            console.log('Non-JSON Response:', xhr.responseText);
                        }
                        showError('Error creating issue: ' + xhr.responseText);
                        console.log('Error creating issue');
                    },
                });
            });
            }
        }
    });

    function createIssueCard(issue) {

        const main = document.createElement("div");
        main.classList.add("card", "p-0", 'issue-card');
        main.id = `issue-${issue.id}`
        main.style.minWidth = "320px";

            const cardHeader = `<div class="card-header justify-content-between">
                <div
                    class="d-flex justify-content-between align-items-center flex-wrap"
                >
                    <div class="d-flex gap-3 align-items-center flex-wrap">
                        <span class="issue-title card-title issueDetails" data-id="${issue.id}" style="font-size: 32px;cursor: pointer;font-family: "Lucida Sans", "Lucida Sans Regular", "Lucida Grande","Lucida Sans Unicode", Geneva, Verdana, sans-serif;">${issue.title}</span>
                    </div>

                    <div class="d-flex justify-content-between gap-2">
                        <div>
                            ${issue.status === 'DUPLICATE' ? '<span class="badge bg-warning">Duplicate</span>' : ''}
                            <span class="badge bg-success">${issue.issueCategory}</span>
                            <span class="badge bg-primary bg-${issue.solved === true ? 'danger' : 'primary'}">
                                ${issue.solved === true ? 'Closed' : 'Open'}
                            </span>
                        </div>
                        ${getLoginUser.currentUser.id === issue.user_pic.id ?
                        `<button type="button" class="btn btn-info see-more-button text-white" data-id="${issue.id}">` +
                            '<i class="fa-solid fa-pen-to-square"></i>' +
                        '</button>'
                        :''}
                    </div>
                </div>
                <div class="col issue-time-line d-flex gap-4 flex-wrap">
                    <div class="d-flex align-items-center gap-2">
                        <p style="padding: 0;margin: 0;opacity: 0.5;">Uploader</p>
                        <span class="card-text" style="font-size: 0.9em;opacity: 1;font-weight: 600;">${issue.user_uploader.name}</span>
                    </div>
                    <div class="d-flex flex-wrap gap-4">
                        <div class="d-flex align-items-center gap-2">
                            <p style="padding: 0;margin: 0;opacity: 0.5;">Posted</p>
                            <span style="font-size: 0.9em;opacity: 1;font-weight: 600;">${formatDate(issue.created_date)}</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <p style="padding: 0;margin: 0;opacity: 0.5;">Modified at</p>
                            <span style="font-size: 0.9em;opacity: 1;font-weight: 600;">${getTimeElapsed(issue.updated_date)}</span>
                        </div>
                    </div>
                </div>
            </div>`;

        const cardBody = document.createElement("div");
        cardBody.classList.add("card-body", "accordion-item", "p-0");
        cardBody.id = `accordionExample-${issue.id}`;

        const h2 = `<h2 class="accordion-header" id="headingTwo">
            <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target= "#collapse-${issue.id}"
                aria-expanded="false"
                aria-controls="collapseTwo"
            >
                Description
            </button>
        </h2>`;

        const collapse = document.createElement("div");
        collapse.id = `collapse-${issue.id}`;
        collapse.classList.add("accordion-collapse", "collapse");
        collapse.setAttribute("aria-labelledby", "headingTwo");
        collapse.setAttribute("data-bs-parent", `#accordionExample-${issue.id}`);

        // quill editor goes in here
        const accordionBody = document.createElement("div");
        accordionBody.id = `quill-editor-${issue.id}`;
        accordionBody.classList.add("accordion-body");

        function initializeQuill() {
            const quillContainer = document.querySelector(`#quill-editor-${issue.id}`);

            let quill;

            if (quillContainer) {
                quill = new Quill(quillContainer, {
                    modules: {
                        toolbar: false,
                    },
                    theme: "snow",
                });

                quill.clipboard.dangerouslyPasteHTML(0, issue.description);
                quill.enable(false);
            }
        }

        cardBody.innerHTML = h2;
        collapse.appendChild(accordionBody);

        cardBody.appendChild(collapse);

        main.innerHTML = cardHeader;
        main.appendChild(cardBody);

        setTimeout(initializeQuill, 1000);

        return main;

    }

    $("#table").bootstrapTable()
    // Function to load data into the Bootstrap Table
    function loadTable() {
        $.ajax({
            url: '/api/issue/list',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                data.forEach(function (issue) {
                    const formattedCreatedDate = formatDate(issue.created_date);

                    $('#table').bootstrapTable('append', {
                        id: issue.id,
                        title: issue.title,
                        issue_category: issue.issueCategory,
                        project_name: issue.projectDto.name,
                        // place: issue.place,
                        // impact: issue.impact,
                        // root_cause: issue.root_cause,
                        // direct_cause: issue.direct_cause,
                        // corrective_action: issue.corrective_action,
                        // preventive_action: issue.preventive_action,
                        responsible_party: issue.responsible_party.name,
                        user_pic: issue.user_pic.name,
                        status: issue.status,
                        solved: issue.solved,
                        created_date: formattedCreatedDate,
                    });
                });
            }
        });
    }

    loadTable()

    const exportDropdown = document.getElementById("exportSelect");

    exportDropdown.addEventListener("change", function () {
        const exportOption = this.value;
        if (exportOption === "all") {
            exportAllRows();
        } else if (exportOption === "selected") {
            const selectedRows = $("#table").bootstrapTable("getSelections");
            exportSelectedRows(selectedRows);
        }
    });

    const exportExcelDropdown = document.getElementById("exportExcelSelect");

    exportExcelDropdown.addEventListener("change", function () {
        const exportOption = this.value;
        if (exportOption === "all") {
            exportAllRowsToExcel();
        } else if (exportOption === "selected") {
            const selectedRows = $("#table").bootstrapTable("getSelections");
            exportSelectedRowsToExcel(selectedRows);
        }
    });


    function exportAllRows() {
        const docDefinition = {
            pageOrientation: 'landscape',
            content: [
                { text: "Issue List Report", style: "header" },
                {
                    table: {
                        headerRows: 1,
                        widths: "auto",
                        body: [
                            ["ID", "Title", "Category", "Project Name", "Status", "Personal In Charge", "Responsible Party", "Solved", "Created Date"],
                            ...$("#table").bootstrapTable("getData").map((row) => [
                                row.id,
                                row.title,
                                row.issue_category,
                                row.project_name,
                                row.status,
                                row.user_pic,
                                row.responsible_party,
                                row.solved,
                                row.created_date
                            ])
                        ]
                    }
                }
            ],
            styles: {
                header: {
                    fontSize: 18,
                    bold: true,
                    margin: [0, 0, 0, 10]
                }
            }
        };
        pdfMake.createPdf(docDefinition).open();
    }


    function exportSelectedRows(selectedRows) {


        const docDefinition = {
            pageOrientation: 'landscape',
            content: [
                {
                    text: "Selected Issues",
                    style: "header"
                },
                {
                    table: {
                        widths: "auto",

                        body: [
                            [
                                "ID",
                                "Title",
                                "Category",
                                "Project Name",
                                "Status",
                                "Personal In Charge",
                                "Responsible Party",
                                "Solved",
                                "Created Date"
                            ],
                            ...selectedRows.map((row) => [
                                row.id,
                                row.title,
                                row.issue_category,
                                row.project_name,
                                row.status,
                                row.user_pic,
                                row.responsible_party,
                                row.solved,
                                row.created_date
                            ])
                        ],
                        layout: 'lightHorizontalLines'
                    }
                }
            ],
            styles: {
                header: {
                    fontSize: 18,
                    bold: true,
                    margin: [0, 0, 0, 10]
                }
            }
        };
        pdfMake.createPdf(docDefinition).open();

    }

    function exportAllRowsToExcel() {
        fetch('/api/issue/list')
            .then(response => response.json())
            .then(data => {
                const headers = ['ID', 'Title', 'Category', 'Project Name', 'Status', 'Personal In Charge', 'Responsible Party', 'Solved', 'Created Date'];
                const rows = data.map(issue => [
                    issue.id,
                    issue.title,
                    issue.issue_category,
                    issue.project_name,
                    issue.status,
                    issue.user_pic,
                    issue.responsible_party,
                    issue.solved,
                    issue.created_date
                ]);

                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet 1');
                XLSX.writeFile(workbook, 'IssueList.xlsx');
            })
            .catch(error => console.error('Error fetching data:', error));
    }

    function exportSelectedRowsToExcel(selectedRows) {
        const headers = ['ID', 'Title', 'Category', 'Project Name', 'Status', 'Personal In Charge', 'Responsible Party', 'Solved', 'Created Date'];
        const rows = selectedRows.map(row => [
            row.id,
            row.title,
            row.issue_category,
            row.project_name,
            row.status,
            row.user_pic,
            row.responsible_party,
            row.solved,
            row.created_date
        ]);

        const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet 1');
        XLSX.writeFile(workbook, 'SelectedIssues.xlsx');
    }

    let currentIssueId;
    $(document).ready(async function () {

        function loadData() {
            $.ajax({
                url: 'api/issue/list',
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    const sortContainer = document.querySelector('#sort-container');

                    for(let i = data.length - 1; i > 0; i--) {
                        const issueDiv = createIssueCard(data[i]);
                        sortContainer.appendChild(issueDiv)
                    }
                },
                error: function (error) {
                    console.log('Error fetching data:', error);
                }
            });
        }

        $("#reset-btn").on("click", function () {
            $("#status-filter").val('');
            $("#solved-filter").val('');
            $("#category-filter").val('');
            document.querySelector("#sort-container").innerHTML = ''
            loadData();
        });

        loadData();

        $('.tab-content').on('click', '.see-more-button', function () {
            // Get the issue ID directly from the button's data-id attribute
            const issueId = $(this).attr('data-id'); // Use $(this) instead of $('#issue-edit-btn')
            console.log('Clicked button with data-iD:', issueId);

            $.ajax({
                url: '/api/issue/list/byId/' + issueId,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    console.log('Data received:', data);
                    if (data) {
                        $('#corrective_actionInput').val(data.corrective_action);
                        $('#preventive_actionInput').val(data.preventive_action);
                        if (data.solved === false) {
                            $('#solve-btn').hide();
                            $('#issue-edit-btn').show();
                        } else {
                            $('#solve-btn').show();
                            $('#issue-edit-btn').hide();
                        }

                        $('#issue-edit-btn').data('issueId', issueId); 
                        $('#solve-btn').data('issueId', issueId);// Set the issueId

                        $('#issueEditModal').modal('show');

                    } else {
                        console.log('No data received for issue ID:', issueId);
                    }
                },
                error: function (xhr, status, error) {
                    console.log('AJAX error:', error);
                }
            });
        });

        $('.tab-content').on('click', '.issueDetails', function () {

            console.log("click on issueDetails ")

            // Get the issue ID directly from the button's data-id attribute
            const issueId = $(this).data('id'); // Use $(this) instead of $('#issue-edit-btn')
            console.log('Clicked button with data-iD:', issueId);

            $.ajax({
                url: 'api/issue/list/byId/' + issueId,
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    console.log('Data received:', data);
                    if (data) {
                        console.log("i have no idea help")
                        $("#details").attr("data-currentEditingIssueId", data.id);
                        $('#issueTitleDetails').val(data.title);
                        $('#issue_categoryDetails').val(data.issueCategory);
                        $('#picDetails').text(data.user_pic.name);
                        $('#rpDetails').text(data.responsible_party.name);
                        const issueDetail = new Quill(document.querySelector('#descriptionDetails'), {
                            modules: {
                                toolbar: toolbaroptions,
                            },
                            theme: 'bubble',
                        });
                        issueDetail.root.innerHTML = '';
                        issueDetail.clipboard.dangerouslyPasteHTML(
                            0,
                            data.description
                        );
                        issueDetail.on('text-change', function (delta, source) {
                            console.log("text change", issueDetail.root.innerHTML)
                            $("#issue-description-save-btn-container").removeClass("d-none")
                        });
                        $("#issue-description-save-btn").on('click', function () {

                            const issue = {
                                id: data.id,
                                description: issueDetail.root.innerHTML,
                                updated_date: Date.now()
                            }

                            console.log("issue", issue)

                            $.ajax({
                                url: `/api/issue/update/${data.id}`, // Replace with your actual URL
                                type: 'PUT', // Change to 'PUT' or 'PATCH' if needed
                                dataType: 'json',
                                contentType: 'application/json',
                                data: JSON.stringify(issue),
                                success: function (response) {
                                    console.log('Ajax request successful:', response);
                                    // Handle success response
                                    $("#issue-description-save-btn-container").addClass('d-none')

                                    const issue = createIssueCard(response);

                                    const oldIssue = $(`#issue-${response.id}`)

                                    oldIssue.replaceWith(issue)

                                    $("#alert-text").text(
                                        "Issue Updated Successfully"
                                    );
                                    $("#alert-modal").modal("show");

                                },
                                error: function (xhr, status, error) {
                                    console.log('Ajax request error:', error);
                                    // Handle error response
                                }
                            });
                        })
                        $('#direct_causeDetails').val(data.direct_cause);
                        $('#root_causeDetails').val(data.root_cause);
                        $('#placeDetails').val(data.place);
                        $('#impactDetails').val(data.impact);
                        $('#correctiveDetails').text(data.corrective_action);
                        $('#preventiveDetails').text(data.preventive_action);
                        $('#solveDateDetails').text(formatDate(data.created_date));
                        $('#issue-edit-btn').data('issueId', issueId); // Set the issueId
                        $('#issueDetailsModal').modal('show');

                        const notSamePerson = getLoginUser.currentUser.id !== data.user_uploader.id

                        if (notSamePerson) {
                            console.log(getLoginUser.currentUser.id)
                            console.log(data.user_uploader.id)
                            console.log(getLoginUser.currentUser.id !== data.user_uploader.id)
                            console.log("solved", data.solved)
                            $('#issueTitleDetails').prop('disabled', true);
                            $('#issue_categoryDetails').prop('disabled', true);
                            $('#descriptionDetails').prop('disabled', true);
                            $('#direct_causeDetails').prop('disabled', true);
                            $('#root_causeDetails').prop('disabled', true);
                            $('#placeDetails').prop('disabled', true);
                            $('#impactDetails').prop('disabled', true);
                            issueDetail.enable(false)
                        } else {
                            if (data.solved) {
                                $('#issueTitleDetails').prop('disabled', true);
                                $('#issue_categoryDetails').prop('disabled', true);
                                $('#descriptionDetails').prop('disabled', true);
                                $('#direct_causeDetails').prop('disabled', true);
                                $('#root_causeDetails').prop('disabled', true);
                                $('#placeDetails').prop('disabled', true);
                                $('#impactDetails').prop('disabled', true);
                                issueDetail.enable(false)
                            } else {
                                $('#issueTitleDetails').prop('disabled', false);
                                $('#issue_categoryDetails').prop('disabled', false);
                                $('#descriptionDetails').prop('disabled', false);
                                $('#direct_causeDetails').prop('disabled', false);
                                $('#root_causeDetails').prop('disabled', false);
                                $('#placeDetails').prop('disabled', false);
                                $('#impactDetails').prop('disabled', false);
                                issueDetail.enable(true)
                            }
                        }

                    } else {
                        console.log('No data received for issue ID:', issueId);
                    }
                },
                error: function (xhr, status, error) {
                    console.log('AJAX error:', error);
                }
            });
        });

        function createPendingIssueCard(issue) {

            const outerDiv = document.createElement("div");
            outerDiv.classList.add("item-issue-approval", 'issue-card');
            outerDiv.id = `issueapprovalitem-${issue.id}`;

            const approvalContainer = document.createElement("div");
            approvalContainer.classList.add(
                "d-inline-flex",
                "bg-primary",
                "gap-2",
                "flex-row",
                "p-2",
                "border-top",
                "rounded-top",
                "text-white",
                "issue-approval"
            );

            approvalContainer.innerHTML += `
                    <input type="radio" name="approval-${issue.id}" value="DUPLICATE">
                    <label>duplicate</label>
                    <input type="radio" name="approval-${issue.id}" value="APPROVE">
                    <label>approve</label>
                    <input type="radio" name="approval-${issue.id}" value="DECLINE">
                    <label>decline</label>
                `;

            const main = document.createElement("div");
            main.classList.add("card", "p-0");
            main.style.minWidth = "320px";

            const cardHeader = `<div class="card-header justify-content-between">
                <div
                    class="d-flex justify-content-between align-items-center flex-wrap"
                >
                    <div class="d-flex gap-3 align-items-center flex-wrap">
                        <span class="issue-title issueDetails" data-id="${issue.id}" style="font-size: 32px;cursor: pointer;font-family: "Lucida Sans", "Lucida Sans Regular", "Lucida Grande","Lucida Sans Unicode", Geneva, Verdana, sans-serif;">${issue.title}</span>
                    </div>

                    <div class="d-flex justify-content-between gap-2">
                        <div>
                            <span class="badge bg-success">${issue.issueCategory}</span>
                            <span class="badge bg-primary bg-${issue.solved === true ? 'danger' : 'primary'}">
                                ${issue.solved === true ? 'Closed' : 'Open'}
                            </span>
                        </div>
                        <button
                            type="button"
                            class="btn btn-info see-more-button text-white"
                            data-id="${issue.id}"
                        >
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                    </div>
                </div>
                <div class="col issue-time-line d-flex gap-4 flex-wrap">
                    <div class="d-flex align-items-center gap-2">
                        <p style="padding: 0;margin: 0;opacity: 0.5;">Uploader</p>
                        <span style="font-size: 0.9em;opacity: 1;font-weight: 600;">${issue.user_uploader.name}</span>
                    </div>
                    <div class="d-flex flex-wrap gap-4">
                        <div class="d-flex align-items-center gap-2">
                            <p style="padding: 0;margin: 0;opacity: 0.5;">Posted</p>
                            <span style="font-size: 0.9em;opacity: 1;font-weight: 600;">${formatDate(issue.created_date)}</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <p style="padding: 0;margin: 0;opacity: 0.5;">Modified at</p>
                            <span style="font-size: 0.9em;opacity: 1;font-weight: 600;">${getTimeElapsed(issue.updated_date)}</span>
                        </div>
                    </div>
                </div>
            </div>`;

            const cardBody = document.createElement("div");
            cardBody.classList.add("card-body", "accordion-item", "p-0");
            cardBody.id = `accordionExample-${issue.id}`;

            const h2 = `<h2 class="accordion-header" id="headingTwo">
            <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target= "#collapse-${issue.id}"
                aria-expanded="false"
                aria-controls="collapseTwo"
            >
                Description
            </button>
        </h2>`;

            const collapse = document.createElement("div");
            collapse.id = `collapse-${issue.id}`;
            collapse.classList.add("accordion-collapse", "collapse");
            collapse.setAttribute("aria-labelledby", "headingTwo");
            collapse.setAttribute("data-bs-parent", `#accordionExample-${issue.id}`);

            // quill editor goes in here
            const accordionBody = document.createElement("div");
            accordionBody.id = `quill-editor-${issue.id}`;
            accordionBody.classList.add("accordion-body");

            function initializeQuill() {
                const quillContainer = document.querySelector(`#quill-editor-${issue.id}`);

                let quill;

                if (quillContainer) {
                    quill = new Quill(quillContainer, {
                        modules: {
                            toolbar: false,
                        },
                        theme: "snow",
                    });

                    quill.clipboard.dangerouslyPasteHTML(0, issue.description);
                    quill.enable(false);
                }
            }

            cardBody.innerHTML = h2;
            collapse.appendChild(accordionBody);

            cardBody.appendChild(collapse);

            main.innerHTML = cardHeader;
            main.appendChild(cardBody);

            setTimeout(initializeQuill, 1000);

            outerDiv.appendChild(approvalContainer);
            outerDiv.appendChild(main);

            return outerDiv;

        }

        const pendingIssueList = await getData(`/api/issue/list/pending/${getLoginUser.currentUser.id}`)

        console.log("pending issue list", pendingIssueList)

        if (pendingIssueList.length !== 0) {
            document.getElementById("notification-light-for-new-issue").classList.remove("d-none")
        }

        document.querySelector("button[data-bs-target='#new-issue-list-container']").addEventListener('show.bs.tab', async () => {

            document.querySelector("#notification-light-for-new-issue").classList.add('d-none')

            const newIssueContainer = document.querySelector("#new-issue-list")

            newIssueContainer.innerHTML = ''

            const aaa = await getData(`/api/issue/list/pending/${getLoginUser.currentUser.id}`)

            if(aaa.length === 0) {
                document.querySelector('#no-new-issue').classList.remove('d-none')
            } else {
                for (let i = aaa.length - 1; i >= 0; i--) {

                const currentIssue = aaa[i];

                newIssueContainer.appendChild(createPendingIssueCard(currentIssue))
            }
            }
        })

        const allApprovalRadios = document.querySelectorAll('.all-approval-input');

        console.log("all radiio button", allApprovalRadios)

        // Attach a click event listener to each radio button in #all-approval
        allApprovalRadios.forEach(allApprovalRadio => {
            allApprovalRadio.addEventListener('click', function () {
                // Get the value of the clicked radio button
                const selectedValue = this.value;
                console.log(selectedValue)

                // Set the corresponding radio buttons in .item sections to the same value
                document.querySelectorAll('.issue-approval input[value="' + selectedValue + '"]').forEach(itemRadio => {
                    itemRadio.checked = true;
                });
            });
        });

        document.querySelector("#all-approval-btn").addEventListener("click", function () {

            const updateIssueList = [];

            const issueList = document.querySelectorAll(".item-issue-approval");

            console.log(issueList)

            issueList.forEach((item, index) => {
                // Get the value of the selected radio button in the corresponding .item section
                console.log("Before radio button selection");
                const selectedRadio = item.querySelector(".issue-approval input[type='radio']:checked");
                console.log(selectedRadio);
                console.log("After radio button selection");
                // Check if a radio button is selected
                if (selectedRadio) {
                    // Add data to the array
                    updateIssueList.push({
                        id: parseInt(item.getAttribute("id").split("-")[1]), // Assuming each item has a unique identifier
                        status: selectedRadio.value
                    });
                } else {
                    // Handle the case where no radio button is selected for an item
                    console.log(`No radio button selected for item ${index + 1}`);
                }
            });
            console.log(updateIssueList)

            if (updateIssueList.length != 0) {
                $.ajax({
                    url: `/api/issue/update/status/issuelist`, // Update the URL to include the issue ID
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(updateIssueList),
                    dataType: 'json',
                    success: function (data) {
                        console.log(data);
                        console.log("Issue Updated Successfully");
                        // alert("Issue Updated Successfully");
                        showSuccess("Issue Updated Successfuly.");
                        $.ajax({
                            url: `/api/issue/list/pending/${getLoginUser.currentUser.id}`, // Update the URL to include the issue ID
                            type: 'GET',
                            success: function (data) {
                                console.log(data);
                                const newIssueList = document.getElementById("new-issue-list")
                                newIssueList.innerHTML = ''
                                for (let i = data.length - 1; i >= 0; i--) {

                                    const currentIssue = data[i];

                                    newIssueList.appendChild(createPendingIssueCard(currentIssue))
                                }
                            },

                        });
                    },

                });
            }

        })
    });
    // for update
    const issueEditBtn = document.getElementById('issue-edit-btn');
    const solveBtn = document.getElementById('solve-btn');

    solveBtn.addEventListener('click', function (e) {
        //alert("Your issue solved");
        console.log($(this).data('issueId'))

        const corrective_action = $('#corrective_actionInput').val();
        const preventive_action = $('#preventive_actionInput').val();
        const issueId = $(this).data('issueId');
        console.log(issueId)
        console.log(solved + " solveddddddd");
        if (corrective_action === "" || preventive_action === "") {
            // alert('Please fill in all the required fields.');
            showError('Please fill in all the required fields.');
            return;
        }
        
        const updatedDetails = {
            corrective_action: corrective_action,
            preventive_action: preventive_action,
            updated_date: new Date().getTime(),
        };
        console.log("UpdateDetails", updatedDetails);
        $.ajax({
            url: `/api/issue/update/${issueId}`, // Update the URL to include the issue ID
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(updatedDetails),
            dataType: 'json',
            success: function (data) {
                console.log(data);
                console.log("Issue Updated Successfully");
                // Update 'solved' to true after a successful AJAX request
                Swal.fire({
                    title: "Success!",
                    text: "You have successfully solved the issue.",
                    icon: "success"
                });
                console.log("Success")
                $("#issue-edit-btn").hide();
                $("#solve-btn").show();
            },
        error: function (xhr, status, error) {
            console.log('Status:', status);
            console.log('Error:', error);
            console.log('Server response:', xhr.responseText);
            if (xhr.getResponseHeader('Content-Type') === 'application/json') {
                // Handle JSON response
                try {
                    const response = JSON.parse(xhr.responseText);
                        console.log('JSON Response:', response);
                    } catch (e) {
                        console.log('JSON parsing error:', e);
                    }
                } else {
                    // Handle non-JSON response
                    console.log('Non-JSON Response:', xhr.responseText);
                }
                alert("Error updating issue: " + xhr.responseText);
                console.log("Error updating issue");
            },
            complete: function () {
                // Optionally, close the modal or perform other actions upon completion
                $('#issueDetailModal').modal('hide');
            }
        });
    });

    issueEditBtn.addEventListener('click', function (e) {
        const corrective_action = $('#corrective_actionInput').val();
        const preventive_action = $('#preventive_actionInput').val();
        const solved = $('#solve-btn').val();
        const issueId = $(this).data('issueId');
        console.log(issueId)
        console.log(solved + " solveddddddd");
        if (corrective_action === "" || preventive_action === "") {
            // alert('Please fill in all the required fields.');
            showError('Please fill in all the required fields.');
            return;
        }

        if (solved === "true") {
            // If solved, hide the "issue-edit-btn" and show the "solve-btn"
            $("#issue-edit-btn").hide();
            $("#solveBtn").show();
        } else {
            // If not solved, show the confirmation modal
            Swal.fire({
                title: "Are you sure?",
                text: "Are you sure you want to solve?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes"
            }).then((result) => {
                if (result.isConfirmed) {
                    const updatedDetails = {
                        corrective_action: corrective_action,
                        preventive_action: preventive_action,
                        updated_date: new Date().getTime(),
                        solved_date: new Date().getTime(),
                        solved: solved,
                    };
                    console.log("UpdateDetails", updatedDetails);

                    $.ajax({
                        url: `/api/issue/update/${issueId}`, // Update the URL to include the issue ID
                        type: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify(updatedDetails),
                        dataType: 'json',
                        success: function (data) {
                            console.log(data);
                            console.log("Issue Updated Successfully");
                            // Update 'solved' to true after a successful AJAX request

                            Swal.fire({
                                title: "Success!",
                                text: "You have successfully solved the issue.",
                                icon: "success"
                            });
                            console.log("Success")
                            $("#issue-edit-btn").hide();
                            $("#solve-btn").show();


                        },
                        error: function (xhr, status, error) {
                            console.log('Status:', status);
                            console.log('Error:', error);
                            console.log('Server response:', xhr.responseText);

                            if (xhr.getResponseHeader('Content-Type') === 'application/json') {
                                // Handle JSON response
                                try {
                                    const response = JSON.parse(xhr.responseText);
                                    console.log('JSON Response:', response);
                                } catch (e) {
                                    console.log('JSON parsing error:', e);
                                }
                            } else {
                                // Handle non-JSON response
                                console.log('Non-JSON Response:', xhr.responseText);
                            }
                            alert("Error updating issue: " + xhr.responseText);
                            console.log("Error updating issue");
                        },
                        complete: function () {
                            // Optionally, close the modal or perform other actions upon completion
                            $('#issueDetailModal').modal('hide');
                        }
                    });

                } else {
                    // User clicked "No," stop the process and close the modal
                    return false;
                }
            });

            // Hide the "solve-btn" regardless of user choice
            $("#solveBtn").hide();
        }
    });


    // for search bar
    $("#status-filter").on("change", function () {
        filterIssues();
    });

    $("#solved-filter").on("change", function () {
        filterSolvedIssues();
    });

    $("#category-filter").on("change", function () {
        filterCategory();
    })


    function filterIssues() {
        var status = $('#status-filter').val();
        console.log("status", status);

        $.ajax({
            url: '/api/issue/list/status/' + status,
            type: 'GET',
            success: function (data) {
                console.log('Success. Received data:', data);

                const sortContainer = $('#sort-container');
                sortContainer.empty();

                // Check if data is not empty
                if (data && data.length > 0) {
                    // Loop through the retrieved data and create content for each item
                    document.querySelector('#no-result').classList.add('d-none')
                    data.forEach(item => {
                        const issueDiv = createIssueCard(item);
                        sortContainer.append(issueDiv);

                    });
                } else {
                    document.querySelector('#no-result').classList.remove('d-none')
                }
            },

            error: function (xhr, status, error) {
                console.error('Error fetching data:', error);
                console.log('XHR:', xhr);
                console.log('Status:', status);

                // Display the error response in the console
                try {
                    const response = JSON.parse(xhr.responseText);
                    console.log('Error response:', response);
                } catch (e) {
                    console.log('Error parsing response:', e);
                }
                showError('Error fetching data.');
                //alert('Error fetching data.');
            }
        });
    }

    // for solved
    function filterSolvedIssues() {
        var solved = $('#solved-filter').val();
        console.log("solved", solved);

        $.ajax({
            url: '/api/issue/list/solved/' + solved,
            type: 'GET',
            success: function (data) {
                console.log('Success. Received data:', data);

                const sortContainer = $('#sort-container');
                sortContainer.empty(); // Clear previous content

                // Check if data is not empty
                if (data && data.length > 0) {
                    // Loop through the retrieved data and create content for each item
                    document.querySelector('#no-result').classList.add('d-none')
                    data.forEach(item => {
                        const issueDiv = createIssueCard(item);
                        sortContainer.append(issueDiv);
                    });
                    
                } else {
                    // Handle case when data is empty
                    document.querySelector('#no-result').classList.remove('d-none')
                }
            },

            error: function (xhr, status, error) {
                console.error('Error fetching data:', error);
                console.log('XHR:', xhr);
                console.log('Status:', status);

                // Display the error response in the console
                try {
                    const response = JSON.parse(xhr.responseText);
                    console.log('Error response:', response);
                } catch (e) {
                    console.log('Error parsing response:', e);
                }

                alert('Error fetching data.');
            }
        });
    }


    // for Category filter
    function filterCategory() {
        var category = $('#category-filter').val();
        console.log("category", category);

        $.ajax({
            url: '/api/issue/list/category/' + category,
            type: 'GET',
            success: function (data) {
                console.log('Success. Received data:', data);

                const sortContainer = $('#sort-container');
                sortContainer.empty(); // Clear previous content

                // Check if data is not empty
                if (data && data.length > 0) {
                    // Loop through the retrieved data and create content for each item
                    document.querySelector('#no-result').classList.add('d-none')
                    data.forEach(item => {
                        const issueDiv = createIssueCard(item);
                        sortContainer.append(issueDiv);
                    });
                    
                } else {
                    // Handle case when data is empty
                    document.querySelector('#no-result').classList.remove('d-none')
                }
            },

            error: function (xhr, status, error) {
                console.error('Error fetching data:', error);
                console.log('XHR:', xhr);
                console.log('Status:', status);

                // Display the error response in the console
                try {
                    const response = JSON.parse(xhr.responseText);
                    console.log('Error response:', response);
                } catch (e) {
                    console.log('Error parsing response:', e);
                }

                alert('Error fetching data.');
            }
        });
    }

    // for issue list
    function showError(message) {
        $("#errorText").text(message);
        $("#errorAlert").show();

        setTimeout(function () {
            $("#errorAlert").hide();
        }, 3000);

        //close alert box
        $(".btn-close").on("click", function () {
            $("#errorAlert").hide();
        });
    }

    function showSuccess(message) {
        $("#successText").text(message);
        $("#successAlert").show();

        setTimeout(function () {
            $("#successAlert").hide();
        }, 3000);

        //close alert box
        $(".btn-close").on("click", function () {
            $("#successAlert").hide();
        });
    }

    function showerror(message) {
        $("#error-text").text(message);
        $("#error-alert").show();

        setTimeout(function () {
            $("#error-alert").hide();
        }, 3000);

        //close alert box
        $(".btn-close").on("click", function () {
            $("#error-alert").hide();
        });
    }

    function showsuccess(message) {
        $("#success-text").text(message);
        $("#success-alert").show();

        setTimeout(function () {
            $("#success-alert").hide();
        }, 3000);

        //close alert box
        $(".btn-close").on("click", function () {
            $("#success-alert").hide();
        });
    }


</script>
<script src="/js/notification.js" type="module"></script>
</body>
</html>
