<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:layout="http://www.w3.org/1999/xhtml" layout:decorate="layout/layout"
      lang="en">
<head>
    <style>

        .ql-toolbar {
            color: white;
        }
        .ql-editor {

        }

        [aria-expanded="true"] .fa-chevron-down {
            transform: rotate(180deg);
        }
    </style>
</head>

<body layout:fragment="content">

<!-- Spinner Start -->
<div id="spinner"
     class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>
<!-- Spinner End -->

<div th:replace="fragments/sidebar :: sidebar"></div>
<div class="container-fluid position-relative d-flex p-0">

    <!-- Content Start -->
    <div class="content" style="
                    background-color: #e5e5f7;
                    opacity: 1;
                    background-image: radial-gradient(
                        #444cf7 0.6000000000000001px,
                        #e5e5f7 0.6000000000000001px
                    );
                    background-size: 12px 12px;">

        <div th:replace="fragments/navigation :: navigation-with-search"></div>

        <div class="container-fluid">


            <div class="container-fluid d-md-block pt-2 ps-s pe-2"
                 id="dropdrown-search-bar">
                <div class="d-flex flex-row justify-content-lg-between position-relative">

                    <div class="d-inline-block d-flex mb-3" style="margin-left:520px;">
                        <select id="status-filter" class="form-control me-2" >
                            <option value="" selected disabled>Status</option>
                            <option value="PENDING">PENDING</option>
                            <option value="APPROVE">APPROVE</option>
                            <option value="DECLINE">DECLINE</option>
                            <option value="DUPLICATE">DUPLICATE</option>
                        </select>

                        <select id="solved-filter" class="form-control me-2">
                            <option value="" selected disabled>Choose</option>
                            <option value="1">Solved</option>
                            <option value="0">Unsolved</option>
                        </select>


                        <select id="category-filter" class="form-control me-2">
                            <option value="" selected disabled>Category</option>
                            <option value="ERROR">ERROR</option>
                            <option value="BUG">BUG</option>
                            <option value="COMMUNICATION">COMMUNICATION</option>
                            <option value="TECHNICAL">TECHNICAL</option>
                            <option value="BUDGET">BUDGET</option>
                            <option value="DESIGN">DESIGN</option>
                            <option value="TESTING">TESTING</option>
                            <option value="OTHER">OTHER</option>

                        </select>

                    </div>


                    <div class="position-absolute end-0 d-flex gap-3">

                        <form class="d-md-flex">
                            <input class="form-control border-0" type="search" placeholder="Search" />
                        </form>
                        <!-- modal toggle button start -->
                        <button type="button" class="btn btn-light align-self-start" data-bs-toggle="modal" data-bs-target="#add-issue">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                        <!-- modal toggle button end -->

                        <!-- sortting button -->
                        <i class="bi bi-sort-alpha-down sort-btn text-dark"></i>
                    </div>

                    <!-- Modal -->
                </div>
            </div>


            <!--  Issue list-->
            <div class="row row-cols-1" id="sort">
                <!--                issue list will be here-->

            </div>
            <!--  Issue list end-->

        </div>
    </div>
    <!-- Content End -->

    <!--    issue detail modal start-->
    <div class="modal fade" id="issueEditModal" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Issue Details</h4>
                    <div class="d-flex justify-content-center align-items-center gap-3">
                        <div class="btn btn-primary" id="issue-edit-btn">Mark as Resolve <i class="fa-solid fa-check"></i></div>
                        <div class="btn btn-success" id="solve-btn">Solve <i class="fa-solid fa-check-double"></i></div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row row-cols-1 row-cols-sm-1 row-cols-md-1 row-cols-lg-1 row-cols-xl-1 row-cols-xxl-1 gap-2">
                            <div class="col mb-3">
                                <input type="hidden" id="solved" />
                                <h5 class="icon-title"><i class="fas fa-wrench text-dark"></i> Corrective Action</h5>
                                <textarea id="corrective_actionInput" class="form-control form-control-sm btn-space" name="corrective_action" rows="5"></textarea>

                            </div>
                            <div class="col mb-3">
                                <h5 class="icon-title"><i class="fas fa-shield-alt text-dark"></i>Preventive Action</h5>
                                <textarea id="preventive_actionInput" class="form-control form-control-sm btn-space" name="preventive_action" rows="5"></textarea>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- add issue modal start -->
<div class="modal fade bd-example-modal-lg" id="add-issue" data-bs-keyboard="true">
    <div class="modal-dialog modal-lg">

        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Create New Issue</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- TODO :: REDESIGN FORM FOR ADDING DEPARTMENT -->

                <!-- issue modal start -->
                <div class="row g-3 "  id="addIssueValidationForm">
                    <div class="col-lg-6">
                        <label for="title" class="col-sm-12 col-form-label" name="title">Issue Title<span
                                style="color:#e86666"> *</span></label>
                        <input type="text" class="form-control border-task-description" id="title" name="title" placeholder="Title">
                    </div>

                    <div class="col-lg-6">
                        <label for="issue_category" class="col-sm-12 col-form-label" name="issueCategory">Issue Category<span
                                style="color:red"> *</span></label>
                        <select class="form-select border-task-description" name="issue_category" id="issue_category" >
                            <option selected>Select Issue Category</option>
                            <option value="ERROR">Error</option>
                            <option value="BUG">Bug</option>
                            <option value="COMMUNICATION">Communication</option>
                            <option value="TECHNICAL">Technical</option>
                            <option value="BUDGET">Budget</option>
                            <option value="DESIGN">Design</option>
                            <option value="TESTING">Testing</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>


                    <div class="col-lg-6">
                        <label for="user_pic" class="col-sm-12 col-form-label" name="user_pic">Person In Charge <span
                                style="color:red"> *</span></label>
                        <select class="form-select border-task-description" data-live-search="true" aria-label="Select PIC"  id="user_pic" name="user_pic" >

                        </select>
                    </div>


                    <div class="col-lg-6">
                        <div class="form-check-inline">
                            <span><label for="responsible_party" class="col-sm-12 col-form-label" name="responsible_type">Responsible Party <span
                                    style="color:red"> *</span>  <input class="form-check-input " type="checkbox" id="responsible_type" name="client_checkbox" value="CLIENT" style="margin-left:130px;"> <label class="form-check-label" >Client</label></label>
                             </span>
                        </div>

                        <select class="form-select border-task-description" aria-label="Select Responsible Party" id="responsible_party" name="responsible_party"></select>

                    </div>

                    <div class="col-lg-12" style="margin-bottom: 80px;">
                        <label for="description" class="col-sm-12 col-form-label" name="name">Description<span
                                style="color:#e86666"> *</span></label>
                        <div class="quill-editor-bubble form-control" id="description" name="description"></div>
                    </div>

                    <div class="col-lg-6">
                        <label for="direct_cause" class="col-sm-12 col-form-label" name="direct_cause">Direct Cause<span
                                style="color:#e86666"> *</span></label>

                        <textarea class="form-control border-task-description" id="direct_cause" name="direct_cause"></textarea>
                    </div>

                    <div class="col-lg-6">
                        <label for="root_cause" class="col-sm-12 col-form-label" name="root_cause">Root Cause<span
                                style="color:#e86666"> *</span></label>
                        <textarea class="form-control border-task-description" id="root_cause"></textarea>
                    </div>

                    <div class="col-lg-6">
                        <label for="place" class="col-sm-12 col-form-label" name="place">Place<span
                                style="color:#e86666"> *</span></label>
                        <textarea class="form-control border-task-description" id="place" name="place"></textarea>
                    </div>

                    <div class="col-lg-6">
                        <label for="impact" class="col-sm-12 col-form-label" name="impact">Impact<span
                                style="color:#e86666"> *</span></label>
                        <textarea class="form-control border-task-description" id="impact" name="impact"></textarea>
                    </div>

                    <div class="w-25 m-auto d-flex justify-content-center align-items-center gap-2 mt-2">
                        <button type="button" id="addIssue" class="btn btn-primary" >Save Data</button>
                    </div>

                </div>
                <!-- issue modal end -->

            </div>
        </div>

    </div>
</div>
<!-- add issue modal end -->



<!--    issue detail modal start-->
<div class="modal fade issueDetails" id="issueDetailsModal" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4>Issue Details</h4>
                <div class="d-flex justify-content-center align-items-center gap-3">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row row-cols-1 row-cols-sm-1 row-cols-md-1 row-cols-lg-1 row-cols-xl-1 row-cols-xxl-1 gap-2">

                        <h6 data-toggle="collapse" href="#details"><i class="fas fa-chevron-circle-down"></i>  Details</h6>
                        <div id="details" class="collapse">
                            <div class="col mb-3">

                                <span class="d-flex custom-issue-margin"><h6 >Title:</h6><p class="icon-title col-6 text-center" id="issueTitleDetails"></p></span>

                            </div>
                            <div class="col mb-3 ">
                                <span class="d-flex custom-issue-margin"><h6>Category:</h6><p class="icon-title badge bg-secondary issue_details_margin" id="issue_categoryDetails"></p></span>

                            </div>

                            <div class="col mb-3 ">
                                <span class="d-flex custom-issue-margin"><h6>Direct Cause:</h6><p class="icon-title col-4 text-center" id="direct_causeDetails"></p></span>

                            </div>

                            <div class="col mb-3">
                                <span class="d-flex custom-issue-margin"><h6 >Root Cause:</h6><p class="icon-title col-4 text-center" id="root_causeDetails"></p></span>

                            </div>

                            <div class="col mb-3 ">
                                <span class="d-flex custom-issue-margin"><h6>Place:</h6><p class="icon-title col-6 text-center" id="placeDetails"></p></span>

                            </div>

                            <div class="col mb-3 ">
                                <span class="d-flex custom-issue-margin"><h6>Impact:</h6><p class="icon-title col-lg-6 text-center" id="impactDetails"></p></span>

                            </div>

                            <div class="col mb-3">
                                <span class="d-flex custom-issue-margin"><h6>Corrective Action:</h6><p class="icon-title col-4 text-center" id="correctiveDetails"></p></span>

                            </div>
                            <div class="col mb-3 ">
                                <span class="d-flex custom-issue-margin"><h6>Preventive Action:</h6><p class="icon-title col-4 text-center" id="preventiveDetails"></p></span>

                            </div>

                            <div class="col mb-3 ">
                                <span class="d-flex custom-issue-margin"><h6>Solved Date:</h6><p class="icon-title col-6 text-center" id="solveDateDetails"></p></span>

                            </div>
                        </div>


                        <h6 data-toggle="collapse" href="#peoples"><i class="fas fa-chevron-circle-down"></i> People</h6>

                        <div id="peoples" class="collapse">
                            <div class="col mb-3 ">
                                <span class="d-flex custom-issue-margin"><h6>Uploader:</h6><p class="icon-title col-6 text-center"  id="uploaderDetails"></p></span>

                            </div>
                            <div  class="col mb-3 ">
                                <span class="d-flex custom-issue-margin"><h6>Person In Charge:</h6><p class="icon-title col-4 text-center" id="picDetails"></p></span>

                            </div>
                            <div  class="col mb-3 ">
                                <span class="d-flex custom-issue-margin"><h6>Responsible Party:</h6><p class="icon-title col-6 text-center" id="rpDetails"></p></span>

                            </div>
                        </div>

                        <div class="accordion accordion-flush" id="accordionFlushExample">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="flush-headingOne">

                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                                        <h6><i class="fas fa-chevron-circle-down"></i>Description</h6>
                                    </button>
                                </h2>
                                <div id="flush-collapseOne" class="accordion-collapse collapse" aria-labelledby="flush-headingOne"  data-bs-parent="#accordionFlushExample">
                                    <div class="accordion-body" id="descriptionDetails"></div>
                                </div>
                            </div>
                            <div class="col mb-3">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"
    ><i class="bi bi-arrow-up"></i
    ></a>
</div>


<!--    for select drop-drown-->
<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>-->

<!-- fontawesome -->
<script src="/js/fontawesome.js"></script>

<!-- jquery -->
<script src="/js/jquery.3.7.1.min.js"></script>


<!-- datable table -->
<script src="/js/databales.min.js"></script>

<!-- bootstrap -->
<script src="/js/bootstrap.bundle.min.js"></script>

<!-- javascript libraries -->
<script src="/lib/chart/chart.min.js"></script>
<script src="/lib/easing/easing.min.js"></script>
<script src="/lib/waypoints/waypoints.min.js"></script>
<script src="/lib/owlcarousel/owl.carousel.min.js"></script>
<script src="/lib/tempusdominus/js/moment.min.js"></script>
<script src="/lib/tempusdominus/js/moment-timezone.min.js"></script>
<script src="/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>
<script src="/lib/quill/quill.min.js"></script>

<!-- Template Javascript -->
<script src="/js/main.js"></script>
<script src="/js/forprogresscircleiguess.js"></script>

<!-- sort (department, project), form validation and search bar behavior are all here -->
<script src="/js/custome.js"></script>

<script src="/js/currentLoginUser.js" type="module" async></script>

<script type="module">
    $(document).ready(function () {
        confirmLogout();
    });
    // Author: Habib Mhamadi
    // Email: habibmhamadi@gmail.comd
    function getTimeAgo(timestamp) {
        const date = new Date(timestamp);
        const currentDate = new Date();
        const timeDifference = currentDate - date;
        const seconds = Math.floor(timeDifference / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days < 1) {
            if (hours < 1) {
                if (minutes < 1) {
                    return "Just now";
                } else {
                    return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                }
            } else {
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            }
        } else if (days < 30) {
            return `${days} day${days > 1 ? 's' : ''} ago`;
        } else {
            const months = Math.floor(days / 30);
            return `${months} month${months > 1 ? 's' : ''} ago`;
        }
    }
    import {getUser} from "/js/currentLoginUser.js";
    import {getTimeElapsed} from "/js/time.js";
    import {getData} from "/js/api-function.js";
    console.log(await getUser());
    let quillEditors = document.querySelectorAll(
        ".quill-editor-bubble"
    );
    let toolbaroptions = [
        // Test-style
        ["bold", "italic", "underline"],

        // Bullet points style...
        [{list: "ordered"}, {list: "bullet"}],

        // Sub and super script...
        [{script: "sub"}, {script: "super"}],

        // Indentation...
        [{indent: "+1"}, {indent: "-1"}],

        // Alignment
        [{align: []}],

        // Header for test, e.g., h1, h2...
        [{header: [1, 2, 3, 4, 5, 6, false]}],

        // Adding image, link, video, or formula
        ["link"],

        // Adding code snippet or blockquote
        ["code-block", "blockquote"],
    ];
    // If you want to initialize Quill for a specific element, you can do it like this:
    let getLoginUser = await getUser();
    console.log("current login user " , getLoginUser)
    let data = [];
    const currentLoginUserRole = getLoginUser.currentUser.role;

    if(currentLoginUserRole === "EMPLOYEE" || currentLoginUserRole === 'FOC' || currentLoginUserRole === 'CONTRACT') {
        document.getElementById("add-issue").classList.remove("d-none");
    }
    // const currentUser = await getUser();
    const dataForIssue = await getData(`/api/project/list/ID/${getLoginUser.currentUser.id}/IN_PROGRESS`)
    console.log("dataForIssue", dataForIssue);
    $(document).ready(async function () {

        let specificQuillEditor = document.querySelector("#description"); // Change the selector as needed
        const a = new Quill(specificQuillEditor, {
            modules: {
                toolbar: toolbaroptions,
            },
            theme: "snow",
        });

        $.get(`api/project/list/ID/${getLoginUser.currentUser.id}/IN_PROGRESS`, function (userData) {
            data = userData; // Set the data array with the retrieved user data
            const user_pic = $('#user_pic');
            user_pic.empty();
            user_pic.append($('<option>', {
                value: '',
                text: 'Select a Member',
                data: {picUrl: ''},
            }));
            if (userData.userList) {
                userData.userList.forEach(user => {
                    user_pic.append($('<option>', {
                        value: user.id,
                        text: user.name,
                        data: { picUrl: user.picUrl },
                        user: user,
                    }));
                });
            }
        });
        let clientData = [];


        function populateClientName() {
            const responsiblePartySelect = $('#responsible_party');
            responsiblePartySelect.empty();
            responsiblePartySelect.append($('<option>', {
                value: `client_${clientData.client.id}`,
                text: `${clientData.client.name}`,
            }));
        }

// Function to populate the responsible party select box with user names
        function populateUserNames() {
            const responsiblePartySelect = $('#responsible_party');
            responsiblePartySelect.empty();

            responsiblePartySelect.append($('<option>', {
                text: 'Select Responsible Party',
            }));

            if (clientData.userList) {
                clientData.userList.forEach(user => {
                    responsiblePartySelect.append($('<option>', {
                        value: `user_${user.id}`,
                        text: `${user.name}`,
                        data: { picUrl: user.picUrl },
                        user: user,
                    }));
                });
            }
        }

// Fetch client data and populate the select box initially
        $.get(`api/project/list/ID/${getLoginUser.currentUser.id}/IN_PROGRESS`, function (data) {
            clientData = data;
            console.log("Client Data: " + JSON.stringify(clientData));
            // Check the "Client" checkbox initially
            $('#responsible_type').prop('checked', true);
            populateClientName();
        });
        let actual_responsible_type = 'CLIENT';

// Event handler for the "Client" checkbox
        $('#responsible_type').on('change', function () {
            const isChecked = $(this).is(':checked');

            if (isChecked) {
                // If the "Client" checkbox is checked, show only the client's name
                populateClientName();
                actual_responsible_type = 'CLIENT'
            } else {
                // If the "Client" checkbox is not checked, show user names
                populateUserNames();
                actual_responsible_type = 'EMPLOYEE'
            }
        });

        $('#addIssue').on('click', async function () {
            const title = $('#title').val();
            const description = a.root.innerHTML;
            const place = $('#place').val();
            const impact = $('#impact').val();
            const root_cause = $('#root_cause').val();
            const direct_cause = $('#direct_cause').val();
            const responsible_party = $('#responsible_party').val();
            const issue_category = $('#issueCategory').val();
            const responsible_type = actual_responsible_type;
            const selectedUserId = $('#user_pic').val();
            const issueId = $('#issue-edit-btn').data('issueId');
            if (
                title === "" ||
                description === "" ||
                place === "" ||
                impact === "" ||
                root_cause === "" ||
                direct_cause === "" ||
                responsible_party === "" ||
                issue_category === ""||
                selectedUserId === ""||
                responsible_type === ""
            ) {
                alert('Please fill in all the required fields.');
                return;
            }


            const selectedResponsibleParty = data.userList.find(user => user.id == responsible_party.split("_")[1]);



            const uploaderId = getLoginUser.currentUser.id;

            console.log("Uploader Id", uploaderId);

            const requestData = {
                title: title,
                description: description,
                place: place,
                impact: impact,
                created_date: new Date().getTime(),
                updated_date: new Date().getTime(),
                root_cause: root_cause,
                direct_cause: direct_cause,
                responsible_party: selectedResponsibleParty.id,
                issueCategory: issue_category,
                responsible_type: responsible_type,
                project_id: dataForIssue.projectId,
                user_uploader:uploaderId,
                user_pic:selectedUserId,


            };

            console.log('Request Data:', requestData);

            $.ajax({
                url: 'api/issue/save',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(requestData),
                dataType: 'json',
                success: function (data) {
                    console.log(data);
                    alert('Issue Created Successfully');
                },
                error: function (xhr, status, error) {
                    console.log('Status:', status);
                    console.log('Error:', error);
                    console.log('Server response:', xhr.responseText);

                    if (xhr.getResponseHeader('Content-Type') === 'application/json') {
                        // Handle JSON response
                        try {
                            const response = JSON.parse(xhr.responseText);
                            console.log('JSON Response:', response);
                        } catch (e) {
                            console.log('JSON parsing error:', e);
                        }
                    } else {
                        // Handle non-JSON response
                        console.log('Non-JSON Response:', xhr.responseText);
                    }

                    alert('Error creating issue: ' + xhr.responseText);
                    console.log('Error creating issue');
                },
            });
        });



    });

    let currentIssueId;
    $(document).ready(function() {
        function loadData() {
            $.ajax({
                url: 'api/issue/list',
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    console.log("Data" + data);
                    const sortContainer = $('#sort');

                    data.forEach(item => {
                        const issueDiv = createIssueCard(item);
                        sortContainer.append(issueDiv);
                    });




                    $('#sort').on('click', '.see-more-button', function() {
                        // Get the issue ID directly from the button's data-id attribute
                        const issueId = $(this).data('id'); // Use $(this) instead of $('#issue-edit-btn')
                        console.log('Clicked button with data-iD:', issueId);

                        $.ajax({
                            url: 'api/issue/list/byId/' + issueId,
                            type: 'GET',
                            dataType: 'json',
                            success: function (data) {
                                console.log('Data received:', data);
                                if (data) {
                                    $('#corrective_actionInput').text(data.corrective_action);
                                    $('#preventive_actionInput').text(data.preventive_action);
                                    if(data.solved === false){
                                        $('#solve-btn').hide();
                                        $('#issue-edit-btn').show();
                                    }else{
                                        $('#solve-btn').show();
                                        $('#issue-edit-btn').hide();
                                    }

                                    $('#issue-edit-btn').data('issueId', issueId); // Set the issueId

                                    $('#issueEditModal').modal('show');

                                } else {
                                    console.log('No data received for issue ID:', issueId);
                                }
                            },
                            error: function (xhr, status, error) {
                                console.log('AJAX error:', error);
                            }
                        });
                    });


                    $('#sort').on('click', '.issueDetails', function() {
                        $('#details').collapse('show');
                        $('#peoples').collapse('show');

                        function formatDate(timestamp) {
                            // Assuming data.solved_date is a timestamp in milliseconds
                            const date = new Date(timestamp);

                            // Format the date as a string (adjust the format as needed)
                            const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

                            return formattedDate;
                        }

                        // Get the issue ID directly from the button's data-id attribute
                        const issueId = $(this).data('id'); // Use $(this) instead of $('#issue-edit-btn')
                        console.log('Clicked button with data-iD:', issueId);

                        $.ajax({
                            url: 'api/issue/list/byId/' + issueId,
                            type: 'GET',
                            dataType: 'json',
                            success: function (data) {
                                console.log('Data received:', data);
                                if (data) {
                                    $('#issueTitleDetails').text(data.title);
                                    $('#issue_categoryDetails').text(data.issueCategory);
                                    $('#uploaderDetails').text(data.user_uploader.name);
                                    $('#picDetails').text(data.user_pic.name);
                                    $('#rpDetails').text(data.responsible_party.name);
                                    $('#descriptionDetails').html(data.description);
                                    $('#direct_causeDetails').text(data.direct_cause);
                                    $('#root_causeDetails').text(data.root_cause);
                                    $('#placeDetails').text(data.place);
                                    $('#impactDetails').text(data.impact);
                                    $('#correctiveDetails').text(data.corrective_action);
                                    $('#preventiveDetails').text(data.preventive_action);
                                    $('#solveDateDetails').text(formatDate(data.solved_date));
                                    $('#issue-edit-btn').data('issueId', issueId); // Set the issueId
                                    $('#issueDetailsModal').modal('show');
                                } else {
                                    console.log('No data received for issue ID:', issueId);
                                }
                            },
                            error: function (xhr, status, error) {
                                console.log('AJAX error:', error);
                            }
                        });
                    });

                },
                error: function (error) {
                    console.log('Error fetching data:', error);
                }
            });
        }
        loadData();


        // details lists

    // for update
        const issueEditBtn = document.getElementById('issue-edit-btn');
        const solveBtn = document.getElementById('solve-btn');

        solveBtn.addEventListener('click',function (e){
            alert("Your issue solved");
        });

        issueEditBtn.addEventListener('click', function (e) {
            const corrective_action = $('#corrective_actionInput').val();
            const preventive_action = $('#preventive_actionInput').val();
            const solved = $('#solve-btn').val();
            const issueId = $(this).data('issueId');
            console.log(solved + " solveddddddd");

            if (solved === "true") {
                // If solved, hide the "issue-edit-btn" and show the "solve-btn"
                $("#issue-edit-btn").hide();
                $("#solveBtn").show();
            } else {
                // If not solved, hide the "solve-btn" and show the "issue-edit-btn"
                $("#issue-edit-btn").show();
                $("#solveBtn").hide();
            }

            if (corrective_action === "" || preventive_action === "") {
                alert('Please fill in all the required fields.');
                return;
            }

            const updatedDetails = {
                corrective_action: corrective_action,
                preventive_action: preventive_action,
                updated_date: new Date().getTime(),
                solved_date: new Date().getTime(),
                solved: solved,
            };

            console.log("UpdateDetails", updatedDetails);

            $.ajax({
                url: `/api/issue/update/${issueId}`, // Update the URL to include the issue ID
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(updatedDetails),
                dataType: 'json',
                success: function (data) {
                    console.log(data);
                    console.log("Issue Updated Successfully");
                    alert("Issue Updated Successfully");
                },
                error: function (xhr, status, error) {
                    console.log('Status:', status);
                    console.log('Error:', error);
                    console.log('Server response:', xhr.responseText);

                    if (xhr.getResponseHeader('Content-Type') === 'application/json') {
                        // Handle JSON response
                        try {
                            const response = JSON.parse(xhr.responseText);
                            console.log('JSON Response:', response);
                        } catch (e) {
                            console.log('JSON parsing error:', e);
                        }
                    } else {
                        // Handle non-JSON response
                        console.log('Non-JSON Response:', xhr.responseText);
                    }
                    alert("Error updating issue: " + xhr.responseText);
                    console.log("Error updating issue");
                },
                complete: function () {
                    // Optionally, close the modal or perform other actions upon completion
                    $('#issueDetailModal').modal('hide');
                }
            });

        });



        // for search bar
        $("#status-filter").on("change", function() {
            filterIssues();
        });

        $("#solved-filter").on("change", function() {
            filterSolvedIssues();
        });

        $("#category-filter").on("change",function (){
            filterCategory();
        })


        function filterIssues() {
            var status = $('#status-filter').val();
            console.log("status", status);

            $.ajax({
                url: '/api/issue/list/status/' + status,
                type: 'GET',
                success: function(data) {
                    console.log('Success. Received data:', data);

                    const sortContainer = $('#sort');
                    sortContainer.empty(); // Clear previous content

                    // Check if data is not empty
                    if (data && data.length > 0) {
                        // Loop through the retrieved data and create content for each item
                        data.forEach(item => {
                            const issueDiv = createIssueCard(item);
                            sortContainer.append(issueDiv);
                        });
                    } else {
                        // Handle case when data is empty
                        sortContainer.html('<p style="text-align: center;">No results found.</p>');
                    }
                },

                error: function(xhr, status, error) {
                    console.error('Error fetching data:', error);
                    console.log('XHR:', xhr);
                    console.log('Status:', status);

                    // Display the error response in the console
                    try {
                        const response = JSON.parse(xhr.responseText);
                        console.log('Error response:', response);
                    } catch (e) {
                        console.log('Error parsing response:', e);
                    }

                    alert('Error fetching data.');
                }
            });
        }

        // for solved
        function filterSolvedIssues() {
            var solved = $('#solved-filter').val();
            console.log("solved", solved);

            $.ajax({
                url: '/api/issue/list/solved/' + solved,
                type: 'GET',
                success: function(data) {
                    console.log('Success. Received data:', data);

                    const sortContainer = $('#sort');
                    sortContainer.empty(); // Clear previous content

                    // Check if data is not empty
                    if (data && data.length > 0) {
                        // Loop through the retrieved data and create content for each item
                        data.forEach(item => {
                            const issueDiv = createIssueCard(item);
                            sortContainer.append(issueDiv);
                        });
                    } else {
                        // Handle case when data is empty
                        sortContainer.html('<p style="text-align: center;">No results found.</p>');
                    }
                },

                error: function(xhr, status, error) {
                    console.error('Error fetching data:', error);
                    console.log('XHR:', xhr);
                    console.log('Status:', status);

                    // Display the error response in the console
                    try {
                        const response = JSON.parse(xhr.responseText);
                        console.log('Error response:', response);
                    } catch (e) {
                        console.log('Error parsing response:', e);
                    }

                    alert('Error fetching data.');
                }
            });
        }


        // for Category filter
        function filterCategory() {
            var category = $('#category-filter').val();
            console.log("category", category);

            $.ajax({
                url: '/api/issue/list/category/'+category,
                type: 'GET',
                success: function(data) {
                    console.log('Success. Received data:', data);

                    const sortContainer = $('#sort');
                    sortContainer.empty(); // Clear previous content

                    // Check if data is not empty
                    if (data && data.length > 0) {
                        // Loop through the retrieved data and create content for each item
                        data.forEach(item => {
                            const issueDiv = createIssueCard(item);
                            sortContainer.append(issueDiv);
                        });
                    } else {
                        // Handle case when data is empty
                        sortContainer.html('<p style="text-align: center;">No results found.</p>');
                    }
                },

                error: function(xhr, status, error) {
                    console.error('Error fetching data:', error);
                    console.log('XHR:', xhr);
                    console.log('Status:', status);

                    // Display the error response in the console
                    try {
                        const response = JSON.parse(xhr.responseText);
                        console.log('Error response:', response);
                    } catch (e) {
                        console.log('Error parsing response:', e);
                    }

                    alert('Error fetching data.');
                }
            });
        }



        // for issue list
        function createIssueCard(item) {
            return `
                    <div class="p-sm-2 ">
                            <div class="card">
                                <div class="card-header border-bottom text-dark">
                                    <div class="d-flex justify-content-between align-items-center gap-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <h5 class="card-title issueDetails" data-id="${item.id}" style="text-decoration: none; cursor:pointer;">${item.title}</h5>

                                            <p class="card-title badge d-flex align-items-center p-1 pe-2 text-primary-emphasis bg-primary border border-primary rounded-pill">
                                                ${item.responsible_party.name}
                                            </p>
                                              <span class="card-title badge rounded-pill bg-${item.solved === true ? 'success' : 'danger'}">
                                            ${item.solved === true ? 'Solved' : 'Unsolved'}

                                        </span>

                                        </div>
                                        <span> <button type="button" class="btn btn-info see-more-button" data-id="${item.id}"><i class="fa-solid fa-pen-to-square"></i></button>
                                        </span>
                                    </div>
                                </div>

                                    <div class="card-body">

                                        <div class="col d-flex justify-content-between align-items-center issue-time-line d-flex gap-2">
                                               <div class="code-block overflow-scroll p-3 "  data-bs-target="#description" style="width:auto; max-height:250px; background:rgba(0, 0, 0, 0) !important;">
                                                <p>${item.description}</p>
                                                </div>

                                        </div>
                                         <p class="badge bg-secondary " style="margin-left:15px;">${item.issueCategory}</p>

                                        <div class="d-flex justify-content-end align-items-center" style="margin-right: 20px;">
                                        <div class="d-flex align-items-center gap-1">
                                            <p> Posted  <span class="text-muted ">${new Date(item.created_date)} </span></p>

                                        </div>
                                        <div class="d-flex align-items-center gap-1" style="margin-left:5px;">
                                            <p> Modified at <span class="text-muted">${getTimeElapsed(item.updated_date)}</span></p>
                                        </div>
                                    </div>
                                    </div>

                                   </div>
                                </div>
                            </div>
                        </div>


                    `;
        }
    });








</script>
</body>
</html>
