<!DOCTYPE html>
<!--<html lang="en">-->
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/layout">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.2/bootstrap-table.min.css"/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-Zl1GKGeg0fOu9BC3A6kbPLF/Jw/FU+GVjxPyjSv+6NzAKHj8xpkRbhmoUHDwnS5rEjNYapnkTz6BUwALf5U7Dg==" crossorigin="anonymous" />

    <style>
        .container {
            margin-top: 50px;

        }

        .table {
            margin-top: 20px;

        }

        .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;

        }

        .page-link {
            color: #0d6efd;
        }

        .page-link:hover {
            color: #0d6efd;
        }

    </style>


</head>
<!--<body>-->
<body layout:fragment="content">

<div th:replace="fragments/sidebar :: sidebar"></div>

<div class="content" style="
                    background-color: #e5e5f7;
                    opacity: 1;
                    background-image: radial-gradient(
                        #444cf7 0.6000000000000001px,
                        #e5e5f7 0.6000000000000001px
                    );
                    background-size: 12px 12px;
                ">

    <div th:replace="fragments/navigation :: navigation-without-search"></div>

    <div class="container">

        <div id="toolbar">
    <span>

        <select class="table btn btn-dark" name="dropdown" id="exportSelect" style="padding: 5px; width: 30%;">
            <option value="" selected disabled>PDF</option>
            <option value="all">Export All</option>
            <option value="selected">Export Selected</option>
        </select>


        <select class="table btn-sm btn-dark" name="dropdown" id="exportExcelSelect" style="padding: 5px; width: 30%;">
            <option value="" selected disabled>Excel</option>
            <option value="all">Export All</option>
            <option value="selected">Export Selected</option>
        </select>


    </span>
        </div>


        <table

                id="table"
                data-toggle="table"
                data-pagination="true"
                data-page-size="5"
                data-page-list="[5, 10, 20, 50, 100, 200]"
                data-sort-priority='[{"sortName": "project_name","sortOrder":"asc"},{"sortName":"title","sortOrder":"asc"}]'
                data-toolbar="#toolbar"
                data-toolbar-align="right"
                data-search="true"
                data-export-types="['csv', 'excel', 'pdf']"
                data-click-to-select="true"
                data-header-style="headerStyle"
                data-url="users"

        >
            <thead >
            <tr>
                <th data-field="state" data-checkbox="true"></th>
                <th data-field="id" data-sortable="true">ID</th>
                <th data-field="title" data-sortable="true">Title</th>
                <th data-field="issue_category" data-sortable="true">Category</th>
                <th data-field="project_name" data-sortable="true">Project Name</th>
                <th data-field="place" data-sortable="true">Place
                    <span style="visibility: hidden;">In this modification,</span>
                </th>
                <th data-field="impact" data-sortable="true">Impact
                    <span style="visibility: hidden;">In this modification, </span>
                </th>
                <th data-field="root_cause" data-sortable="true">Root Cause
                    <span style="visibility: hidden;">In this modification,</span></th>
                <th data-field="direct_cause" data-sortable="true">Direct Cause
                    <span style="visibility: hidden;">In this modification,</span></th>
                <th data-field="corrective_action" data-sortable="true">Corrective Action
                    <span style="visibility: hidden;">In this modification, </span></th>
                <th data-field="preventive_action" data-sortable="true">Preventive Action
                    <span style="visibility: hidden;">In this modification, </span></th>
                <th data-field="responsible_party" data-sortable="true">Responsible Party</th>
                <th data-field="user_pic" data-sortable="true">Personal In Charge</th>
                <th data-field="status" data-sortable="true">Status</th>
                <th data-field="solved" data-sortable="true">Solved</th>
                <th data-field="created_date" data-sortable="true">Created Date</th>

            </tr>
            </thead>
            <tbody>
            <!-- Data will be dynamically loaded here -->
            </tbody>
        </table>
    </div>

    <script src="/js/fontawesome.js"></script>
    <!-- jquery -->
    <script src="/js/jquery.3.7.1.min.js"></script>
    <!-- bootstrap -->
    <script src="/js/bootstrap.bundle.min.js"></script>
    <!-- Template Javascript -->
    <script src="/js/main.js"></script>

    <script src="/js/custome.js"></script>

    <script src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>

    <script>

        function formatDate(timestamp) {

            const date = new Date(timestamp);

            const formattedDate = `${date.toLocaleDateString()}`;

            return formattedDate;
        }

        $(document).ready(function () {
            $('#table').bootstrapTable({
                columns: [{
                    field: 'id',
                    title: 'ID'
                }, {
                    field: 'title',
                    title: 'Title'
                }, {
                    field: 'issue_category',
                    title: 'Category'
                }, {
                    field: 'project_name',
                    title: 'Project Name'
                },{
                    field: 'place',
                    title: 'Place'
                },{
                    field: 'impact',
                    title: 'Impact'
                },{
                    field: 'root_cause',
                    title: 'Root Cause'
                }, {
                    field: 'direct_cause',
                    title: 'Direct Cause'
                },{
                    field: 'corrective_action',
                    title: 'Corrective Action'
                },{
                    field: 'preventive_action',
                    title: 'Preventive Action'
                }, {
                    field: 'responsible_party',
                    title: 'Responsible Party'
                },
                    {
                        field: 'user_pic',
                        title: 'Personal In Charge'
                    },
                    {

                        field: 'status',
                        title: 'Status'
                    },{
                        field: 'solved',
                        title: 'Solved'

                    },
                    {
                        field: 'created_date',
                        title: 'Created Date'
                    }],


            });

            function loadTable() {
                $.ajax({
                    url: '/api/issue/list',
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        data.forEach(function (issue) {
                            const formattedCreatedDate = formatDate(issue.created_date);

                            $('#table').bootstrapTable('append', {
                                id: issue.id,
                                title: issue.title,
                                issue_category: issue.issueCategory,
                                project_name: issue.projectDto.name,
                                // place: issue.place,
                                // impact: issue.impact,
                                // root_cause: issue.root_cause,
                                // direct_cause: issue.direct_cause,
                                // corrective_action: issue.corrective_action,
                                // preventive_action: issue.preventive_action,
                                responsible_party: issue.responsible_party.name,
                                user_pic: issue.user_pic.name,
                                status: issue.status,
                                solved: issue.solved,
                                created_date: formattedCreatedDate,

                            });
                        });
                    }
                });
            }

            loadTable();

            const exportDropdown = document.getElementById("exportSelect");

            exportDropdown.addEventListener("change", function () {
                const exportOption = this.value;
                if (exportOption === "all") {
                    exportAllRows();
                } else if (exportOption === "selected") {
                    const selectedRows = $("#table").bootstrapTable("getSelections");
                    exportSelectedRows(selectedRows);
                }
            });

            const exportExcelDropdown = document.getElementById("exportExcelSelect");

            exportExcelDropdown.addEventListener("change", function () {
                const exportOption = this.value;
                if (exportOption === "all") {
                    exportAllRowsToExcel();
                } else if (exportOption === "selected") {
                    const selectedRows = $("#table").bootstrapTable("getSelections");
                    exportSelectedRowsToExcel(selectedRows);
                }
            });


            function exportAllRows() {
                const docDefinition = {
                    pageOrientation: 'landscape',
                    content: [
                        { text: "Issue List Report", style: "header" },
                        {
                            table: {
                                headerRows: 1,
                                widths: "auto",
                                body: [
                                    ["ID", "Title", "Category", "Project Name", "Status", "Personal In Charge", "Responsible Party", "Solved", "Created Date"],
                                    ...$("#table").bootstrapTable("getData").map((row) => [
                                        row.id,
                                        row.title,
                                        row.issue_category,
                                        row.project_name,
                                        row.status,
                                        row.user_pic,
                                        row.responsible_party,
                                        row.solved,
                                        row.created_date
                                    ])
                                ]
                            }
                        }
                    ],
                    styles: {
                        header: {
                            fontSize: 18,
                            bold: true,
                            margin: [0, 0, 0, 10]
                        }
                    }
                };
                pdfMake.createPdf(docDefinition).open();
            }


            function exportSelectedRows(selectedRows) {


                const docDefinition = {
                    pageOrientation: 'landscape',
                    content: [
                        {
                            text: "Selected Issues",
                            style: "header"
                        },
                        {
                            table: {
                                widths: "auto",

                                body: [
                                    [
                                        "ID",
                                        "Title",
                                        "Category",
                                        "Project Name",
                                        "Status",
                                        "Personal In Charge",
                                        "Responsible Party",
                                        "Solved",
                                        "Created Date"
                                    ],
                                    ...selectedRows.map((row) => [
                                        row.id,
                                        row.title,
                                        row.issue_category,
                                        row.project_name,
                                        row.status,
                                        row.user_pic,
                                        row.responsible_party,
                                        row.solved,
                                        row.created_date
                                    ])
                                ],
                                layout: 'lightHorizontalLines'
                            }
                        }
                    ],
                    styles: {
                        header: {
                            fontSize: 18,
                            bold: true,
                            margin: [0, 0, 0, 10]
                        }
                    }
                };
                pdfMake.createPdf(docDefinition).open();

            }

        });

        function exportAllRowsToExcel() {
            fetch('/api/issue/list')
                .then(response => response.json())
                .then(data => {
                    const headers = ['ID', 'Title', 'Category', 'Project Name', 'Status', 'Personal In Charge', 'Responsible Party', 'Solved', 'Created Date'];
                    const rows = data.map(issue => [
                        issue.id,
                        issue.title,
                        issue.issue_category,
                        issue.project_name,
                        issue.status,
                        issue.user_pic,
                        issue.responsible_party,
                        issue.solved,
                        issue.created_date
                    ]);

                    const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet 1');
                    XLSX.writeFile(workbook, 'IssueList.xlsx');
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function exportSelectedRowsToExcel(selectedRows) {
            const headers = ['ID', 'Title', 'Category', 'Project Name', 'Status', 'Personal In Charge', 'Responsible Party', 'Solved', 'Created Date'];
            const rows = selectedRows.map(row => [
                row.id,
                row.title,
                row.issue_category,
                row.project_name,
                row.status,
                row.user_pic,
                row.responsible_party,
                row.solved,
                row.created_date
            ]);

            const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet 1');
            XLSX.writeFile(workbook, 'SelectedIssues.xlsx');
        }




    </script>

</body>
</html>