<!DOCTYPE html>
<html
        lang="en"
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="layout/layout"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
</head>

<body layout:fragment="content">

<script type="module" src="/js/callDataForTask.js" async></script>

<!-- Spinner Start -->
<div
        id="spinner"
        class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center"
>
    <div
            class="spinner-border text-primary"
            style="width: 3rem; height: 3rem"
            role="status"
    >
        <span class="sr-only">Loading...</span>
    </div>
</div>
<!-- Spinner End -->

<div th:replace="fragments/sidebar :: sidebar"></div>
<div class="container-fluid position-relative d-flex p-0">
    <!-- Content Start -->
    <div
            class="content"
            style="
                    background-color: #e5e5f7;
                    opacity: 1;
                    background-image: radial-gradient(
                        #444cf7 0.6000000000000001px,
                        #e5e5f7 0.6000000000000001px
                    );
                    background-size: 12px 12px;
                "
    >
        <div
                th:replace="fragments/navigation :: navigation-without-search"
        ></div>

        <div class="container-fluid mt-2">
            <!-- nav for task and gantt chart start -->
            <nav>
                <ul class="nav nav-tabs rounded-top" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button
                                class="nav-link active border-primary border border-bottom-0"
                                id="tasks-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#task"
                                type="button"
                                role="tab"
                                aria-controls="task"
                                aria-selected="false"
                        >
                            Tasks
                            <p style="display:none;" th:text="${projectId}" id="projectId"></p>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button
                                class="nav-link border-primary border border-bottom-0 rounded-top"
                                id="gantt-chart-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#gantt-chart"
                                type="button"
                                role="tab"
                                aria-controls="gantt-chart"
                                aria-selected="false"
                        >
                            Calendar
                        </button>
                    </li>
                </ul>
            </nav>
            <!-- nav for task and gantt chart end -->
            <div
                    class="tab-content position-relative"
                    style="height: 600px"
                    id="myTabContent"
            >
                <div
                        class="tab-pane fade show active"
                        id="task"
                        role="tabpanel"
                        aria-labelledby="tasks-tab"
                >
                    <div
                            class="d-flex justify-content-end trash-can-container dummy-trash position-absolute"
                            style="bottom: 100px; right: 0; width: 60px"
                    >
                            <span class="trash align-self-end dummy-trash">
                                <span class="dummy-trash"></span>
                            </span>
                    </div>
                    <div class="board">
                        <!-- add task form start -->
                        <!-- add task form end -->

                        <div class="lanes" id="sort-container">
                            <div class="lane">
                                <h3
                                        class="heading bg-primary text-white rounded-top p-2 d-flex justify-content-between align-items-center"
                                >
                                    TODO
                                    <button
                                            type="submit"
                                            class="btn btn-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#add-task"
                                    >
                                        <i
                                                class="bi bi-plus-circle"
                                        ></i>
                                    </button>
                                </h3>
                                <div class="swim-lane p-3" id="TODO">
                                </div>
                                <div
                                        class="bg-primary rounded-bottom"
                                        style="height: 10px"
                                ></div>
                            </div>
                            <!-- doing start -->
                            <div class="lane">
                                <h3
                                        class="heading bg-info text-white rounded-top p-2"
                                >
                                    DOING
                                </h3>
                                <div
                                        class="swim-lane p-3"
                                        id="IN_PROGRESS"
                                >
                                </div>
                                <div
                                        class="bg-info rounded-bottom"
                                        style="height: 10px"
                                ></div>
                            </div>
                            <!-- doing end -->
                            <!-- done start -->
                            <div class="lane">
                                <h3
                                        class="heading bg-success text-white rounded-top p-2"
                                >
                                    DONE
                                </h3>
                                <div
                                        class="swim-lane p-3"
                                        id="FINISHED"
                                ></div>
                                <div
                                        class="bg-success rounded-bottom"
                                        style="height: 10px"
                                ></div>
                            </div>
                            <!-- done end -->
                        </div>
                    </div>
                </div>
                <!-- calendar start -->
                <div
                        class="tab-pane fade mt-3"
                        id="gantt-chart"
                        role="tabpanel"
                        aria-labelledby="gantt-chart-tab"
                >
                    <div id="calendar"></div>
                </div>

                <!-- calendar end -->
            </div>
        </div>
    </div>
    <!-- Content End -->

    <!-- task's details start -->
    <div class="modal fade" id="task-details" data-bs-keyboard="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content task-content">
                <div class="modal-header">
                    <h2 class="card-title display-6" style="text-align: center;" id="taskTitle">
                    </h2>
                    <span class='ms-3 rounded-2 p-2 text-white' id="status"></span>

                    <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body">
                    <div class="row row-cols-2">
                        <div class="col-lg-12 mb-4 col-md-12 col-sm-12">
                                    <span
                                    ><i
                                            class="fa-solid fa-bars-staggered"
                                    ></i
                                    ></span>
                            <label
                                    id="description-label"
                                    class="editable-label"
                            >
                                Description</label
                            >
                            <textarea
                                    id="description-editor"
                                    class="form-control editable-input"
                                    name="description"
                                    rows="4"
                                    disabled
                            ></textarea>
                        </div>

                        <div class="col-lg-6 mb-4">
                            <i class="fa-solid fa-thumbtack"></i>
                            <label
                                    id="duration"
                                    class="editable-label"
                            >
                                Type of Task</label
                            >
                            <div class="mt-2">
                                <span class="bg-secondary text-white border-0 p-2 rounded-1" id="task-group"></span>
                            </div>

                        </div>

                        <div class="col-lg-6 mb-4">
                            <i class="fa-solid fa-users"></i>
                            <label
                                    for="assigned-member-tagify"
                            >
                                Assigned Member </label
                            >
                            <input
                                    id="assigned-member-tagify"
                                    class="editable-input"
                                    name="member-tags"
                                    sec:authorize="hasRole('PROJECT_MANAGER')"
                            />
                            <div class="mt-2" sec:authorize="hasAnyRole('FOC','EMPLOYEE','CONTRACT','PMO','DEPARTMENT_HEAD','SDQC')">
                                <span class="bg-dark text-white border-0 p-2 rounded-1"
                                      id="assigned-member-span"></span>
                            </div>
                        </div>

                        <div class="col-lg-6 mb-4">
                                    <span
                                    ><i
                                            class="fa-solid fa-calendar-days"
                                    ></i
                                    ></span>
                            <label
                                    class="editable-label"
                            >
                                Start Date</label
                            >
                            <input
                                    type="date"
                                    id="task-detail-start-date"
                                    name="start_date"
                                    class="form-control border-task editable-input"
                                    dir="auto"
                                    data-autosize="true"
                                    style="
                                            overflow: hidden;
                                            overflow-wrap: break-word;
                                            height: 37px;
                                        "
                                    disabled
                            />
                        </div>

                        <div class="col-lg-6 mb-4">
                                    <span
                                    ><i
                                            class="fa-solid fa-calendar-days"
                                    ></i
                                    ></span>
                            <label
                                    class="editable-label"
                            >
                                Due Date</label
                            >
                            <input
                                    type="date"
                                    id="task-detail-due-date"
                                    name="due-date"
                                    class="form-control border-task editable-input"
                                    dir="auto"
                                    data-autosize="true"
                                    style="
                                            overflow: hidden;
                                            overflow-wrap: break-word;
                                            height: 37px;
                                        "
                                    disabled
                            />
                        </div>
                    </div>

                    <!--                    edit button and cancel button -->
                    <div class="text-center mt-3">
                        <button
                                type="submit"
                                class="btn btn-primary col-2"
                                data-dismiss="#task-details"
                                id="task-edit-btn"
                        >
                            Edit
                        </button>
                        <button
                                type="reset"
                                class="btn btn-secondary mr-3"
                                data-bs-dismiss="modal"
                                id="task-cancel-btn"
                        >
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- task's details end -->

    <!-- add task -->
    <div class="modal fade" data-bs-keyboard="true" id="add-task">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content task-content">
                <div class="modal-header">
                    <h2 class="card-title" style="text-align: center">
                        Add Task
                    </h2>
                    <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3" id="todo-form">
                        <div class="col-12">
                            <label
                                    for="title"
                                    class="col-sm-12 col-form-label"
                            >Task Title <span
                                    style="color:red"> *</span></label
                            >
                            <input
                                    type="text"
                                    class="form-control border-task-title"
                                    id="title"
                                    name="title"
                            ></input>
                        </div>

                        <div class="col-12">
                            <label
                                    for="description"
                                    class="col-sm-12 col-form-label"
                            >Description <span
                                    style="color:red"> *</span></label
                            >
                            <textarea
                                    class="form-control border-task-description"
                                    id="description"
                                    name="description"
                                    rows="2"
                            ></textarea>
                        </div>

                        <div class="col-lg-6">
                            <label
                                    for="select-member"
                                    class="col-sm-12 col-form-label"
                            >Assign Members<span style="color: red">
                                            *</span
                            ></label
                            >
                            <input
                                    type="text"
                                    name="member-tags"
                                    id="select-member"
                                    placeholder="Select An Employee"
                            />
                        </div>
                        <div class="col-lg-6">
                            <label for="group" class="col-sm-12 col-form-label">Group <span
                                    style="color:red"> *</span></label>
                            <select class="form-control" aria-label="Select Group" data-live-search="true"
                                    id="group" name="group">
                                <option value="A">A - Related With Project Development</option>
                                <option value="B">B - Training</option>
                                <option value="C">C - Idling</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label
                                    for="start_time"
                                    class="col-sm-12 col-form-label"
                            >Start Date
                                <span style="color: red">
                                            *</span
                                ></label
                            >
                            <input
                                    type="date"
                                    class="form-control border-task-description"
                                    id="start_time"
                                    name="start_time"
                            />
                        </div>

                        <div class="col-md-6">
                            <label
                                    for="end_time"
                                    class="col-sm-12 col-form-label"
                            >End Date
                                <span style="color: red">
                                            *</span
                                ></label
                            >
                            <input
                                    type="date"
                                    class="form-control border-task-description"
                                    id="end_time"
                                    name="end_time"
                            />
                        </div>


                        <div class="text-center mt-3">
                            <button
                                    type="submit"
                                    class="btn btn-primary col-2"
                                    data-dismiss="modal"
                                    id="task-add-btn"
                            >
                                Add
                            </button>
                            <button
                                    type="reset"
                                    class="btn btn-secondary mr-3"
                                    data-dismiss="modal"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- add task -->

    <!-- confrim box for delete -->
    <div
            class="modal fade"
            id="confirm-box"
            data-bs-keyboard="false"
            data-bs-backdrop="static"
    >
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <span>Are you sure want to delete ?</span>
                    <button class="btn btn-danger col me-1">YES</button>
                    <button class="btn btn-primary col" data-bs-dismiss="modal" aria-label="Close">NO</button>
                </div>
            </div>
        </div>
    </div>
    <!-- confirm box for delete -->

    <!--    for select drop-drown-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>

    <!-- fontawesome -->
    <script src="/js/fontawesome.js"></script>

    <!-- jquery -->
    <script src="/js/jquery.3.7.1.min.js"></script>

    <!-- datable table -->
    <script src="/js/databales.min.js"></script>

    <!-- bootstrap -->
    <script src="/js/bootstrap.bundle.min.js"></script>

    <!-- javascript libraries -->
    <script src="/lib/chart/chart.min.js"></script>
<!--    <script src="/lib/easing/easing.min.js"></script>-->
<!--    <script src="/lib/waypoints/waypoints.min.js"></script>-->
<!--    <script src="/lib/owlcarousel/owl.carousel.min.js"></script>-->
<!--    <script src="/lib/tempusdominus/js/moment.min.js"></script>-->
<!--    <script src="/lib/tempusdominus/js/moment-timezone.min.js"></script>-->
<!--    <script src="/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>-->
    <script src="/lib/quill/quill.min.js"></script>

    <!-- toast ui calendar -->
<!--    <script src="https://uicdn.toast.com/tui.code-snippet/latest/tui-code-snippet.js"></script>-->
<!--    <script src="https://uicdn.toast.com/tui.dom/v3.0.0/tui-dom.js"></script>-->
<!--    <script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.min.js"></script>-->
<!--    <script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.js"></script>-->
<!--    <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script>-->



    <!-- Template Javascript -->
    <script src="/js/main.js"></script>
    <script src="/js/forprogresscircleiguess.js"></script>

    <!-- sort (department, project), form validation and search bar behavior are all here -->
    <script src="/js/custome.js"></script>

    <!--    for assign member-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tagify/4.2.0/tagify.min.js"></script>

    <script type="module">
        import {getData, sendData} from "/js/api-function.js";

        // Get the project ID from the hidden element
        const projectId = document.getElementById("projectId").innerText;

        // Function to fetch the members' list from the backend API
        let membersList = [];
        $.ajax({
            url: "/api/user/list/projectId/" + projectId,
            type: "GET",
            async: false,
            success: function (data) {
                membersList = data;
            },
        });
        console.log("MEMBERS LIST", membersList);

        var memberInputTag = document.querySelector('input[id=select-member]'),
            tagify = new Tagify(memberInputTag, {
                enforceWhitelist: true,
                mode: "select",
                whitelist: membersList.map((member) => {
                    return member.name + " | " + member.role;
                }),
                blacklist: ['foo', 'bar'],
            })

        // bind events
        tagify.on('add', onAddTag)
        tagify.DOM.input.addEventListener('focus', onSelectFocus)

        function onAddTag(e) {

            console.log(e.detail);

        }

        function onSelectFocus(e) {
            console.log(e)
        }

        // Get all elements with the common class name
        const editableInputs =
            document.querySelectorAll(".editable-input");
        const editBtn = document.getElementById("task-edit-btn");
        const cancelBtn = document.getElementById("task-cancel-btn");

        let isEditing = false;

        editBtn.addEventListener("click", function () {
            if (!isEditing) {
                editBtn.innerText = "Save";

                editableInputs.forEach((input) => {
                    input.removeAttribute("disabled");
                });

                isEditing = true;
            }

        });

        cancelBtn.addEventListener("click", function (event) {
            if (isEditing) {
                editBtn.innerText = "Edit";
                // don't let the button close modal
                event.preventDefault();
                editableInputs.forEach((input) => {
                    input.setAttribute("disabled", "");
                });
                isEditing = false;
            }

        });

        const todoLane = document.getElementById("TODO");
        const inProgress = document.getElementById("IN_PROGRESS");
        const finished = document.getElementById("FINISHED");
        let currentZone = null;
        let currentTask;
        let currentTaskData;
        const status = ['TODO', 'IN_PROGRESS', 'FINISHED']
        const modal = document.getElementById("task-details");

        function createTaskDiv(task) {
            const taskDiv = document.createElement("div");
            taskDiv.classList.add(
                "task",
                "py-1",
                "row",
                "rounded-2",
                "border-2",
                "border"
            );
            switch (task.status) {
                case "TODO":
                    taskDiv.classList.add("border-primary");
                    break;
                case "IN_PROGRESS":
                    taskDiv.classList.add("border-dark");
                    break;
                case "FINISHED":
                    taskDiv.classList.add("border-success");
                    break;
            }
            taskDiv.draggable = true;

            // Add a data attribute for modal triggering (if needed)
            taskDiv.setAttribute("data-bs-toggle", "modal");
            taskDiv.setAttribute("data-bs-target", "#task-details");

            const titleDiv = document.createElement("div");
            titleDiv.classList.add(
                "col-12",
                "mb-2",
                "lh-1",
                "mh-50",
                "modal-detail-title",
                "text-break"
            );
            titleDiv.textContent = task.title;

            const imgDiv = document.createElement("div");
            imgDiv.classList.add(
                "col",
                "d-flex",
                "justify-content-between",
                "align-items-center"
            );

            const img = document.createElement("img");
            img.src =
                "/images/avatars/employee_avatar.svg"; // Assuming you want to change the image based on task.id
            img.classList.add("img-fluid", "rounded-circle");
            img.alt = "";
            img.style.width = "30px";

            imgDiv.appendChild(img);

            taskDiv.appendChild(titleDiv);
            taskDiv.appendChild(imgDiv);

            return taskDiv;
        }

        let taskList = [];

        // Fetch the tasks from the backend API
        $.ajax({
            url: "/api/task/list/project/" + projectId,
            type: "GET",
            async: false,
            success: function (data) {
                taskList = data;
            },
        });

        for (let i = 0; i < taskList.length; i++) {
            const task = taskList[i];

            const taskDiv = createTaskDiv(task);

            taskDiv.setAttribute("index", i);

            // Determine the status of the task and append it to the appropriate lane
            if (task.status === "TODO") {
                todoLane.appendChild(taskDiv);
            } else if (task.status === "IN_PROGRESS") {
                inProgress.appendChild(taskDiv);
            } else if (task.status === "FINISHED") {
                finished.appendChild(taskDiv);
            }
            taskDiv.addEventListener("dragstart", (e) => {
                taskDiv.classList.add("is-dragging");
                currentZone = taskDiv.parentElement;
                console.log("dragging");
                currentTask = taskDiv;
                console.log("CURRENT TASK ", currentTask)
            });

            taskDiv.addEventListener("click", (e) => {

                currentTaskData = taskList[parseInt(taskDiv.getAttribute('index'))]
                console.log('click task so should change the current task data', currentTaskData)
                //change input value from that taskdata
                document.getElementById('taskTitle').innerText = currentTaskData.title
                document.getElementById('description-editor').value = currentTaskData.description
                // document.getElementById('tduration').value = currentTaskData.duration
                // document.getElementById('task-detail-start_time').value = currentTaskData.start_time

                // change status span text according to the status and also change badge color
                if (currentTaskData.status === 'TODO') {
                    document.getElementById('status').innerText = "TODO"
                    document.getElementById('status').classList.add('bg-primary')
                } else if (currentTaskData.status === 'IN_PROGRESS') {
                    document.getElementById('status').innerText = "IN PROGRESS"
                    document.getElementById('status').classList.add('bg-info')
                } else {
                    document.getElementById('status').innerText = "FINISHED"
                    document.getElementById('status').classList.add('bg-success')
                }

                if (currentTaskData.tasksGroup === 'A') {
                    document.getElementById('task-group').innerText = "Group A - Related With Project Development"
                } else if (currentTaskData.tasksGroup === 'B') {
                    document.getElementById('task-group').innerText = "Group B - Training"
                } else {
                    document.getElementById('task-group').innerText = "Group C - Idling"
                }

                // Convert timestamp to Date objects
                const startDate = new Date(currentTaskData.plan_start_time);
                const endDate = new Date(currentTaskData.plan_end_time);

// Get the date strings in 'yyyy-mm-dd' format
                const startDateString = startDate.toISOString().split('T')[0];
                const endDateString = endDate.toISOString().split('T')[0];

                console.log("START DATE STRING", startDateString)
                console.log("END DATE STRING", endDateString)

// Set the values in the input fields
                document.getElementById('task-detail-start-date').value = startDateString;
                document.getElementById('task-detail-due-date').value = endDateString;

                //preselect the tagify if that element exists
                const assignedMemberTagifyElement = document.getElementById('assigned-member-tagify');
                if (assignedMemberTagifyElement) {
                    const assignedMemberTagify = document.getElementById('assigned-member-tagify'),
                        tagify = new Tagify(assignedMemberTagify, {
                            enforceWhitelist: true,
                            mode: "select",
                            whitelist: membersList.map((member) => {
                                return member.name + " | " + member.role;
                            }),
                            blacklist: ['foo', 'bar'],
                        })

                    tagify.addTags(currentTaskData.userDto.name + " | " + currentTaskData.userDto.role)
                }
                console.log("CURRENT TASK DATA", currentTaskData)

                const assignedMemberSpan = document.getElementById('assigned-member-span')
                //to check if that element exists
                if (assignedMemberSpan) {
                    // Check if the user has any of the specified roles
                    if (currentTaskData.userDto.role === 'FOC' || currentTaskData.userDto.role === 'EMPLOYEE' || currentTaskData.userDto.role === 'CONTRACT' || currentTaskData.userDto.role === 'PMO' || currentTaskData.userDto.role === 'DEPARTMENT_HEAD' || currentTaskData.userDto.role === 'SDQC') {
                        console.log("the user has one of the specified roles")
                        assignedMemberSpan.innerText = currentTaskData.userDto.name + " | " + currentTaskData.userDto.role
                    }
                }
            });

            taskDiv.addEventListener("dragend", () => {
                taskDiv.classList.remove("is-dragging");
                currentTaskData =
                    taskList[
                        parseInt(currentTask.getAttribute("index"))
                        ];
                console.log("CURRENT TASK DATA", currentTaskData)
                if (currentZone.classList.contains("dummy-trash")) {
                    bModal.show();
                } else if (status.some(a => currentZone.getAttribute("id") === a)) {
                    console.log("the task indeed drop on the one of the three zone")
                    console.log(currentTaskData.status, currentZone.getAttribute("id"))
                    if (currentTaskData.status !== currentZone.getAttribute("id")) {
                        currentTaskData.status = currentZone.getAttribute("id")
                        if (currentTaskData.status === 'IN_PROGRESS') {
                            currentTaskData.actual_start_time = new Date().getTime()
                        }
                        if (currentTaskData.status === 'FINISHED') {
                            currentTaskData.actual_end_time = new Date().getTime()
                        }
                        console.log("CURRENT TASK DATA", currentTaskData)
                        sendData(
                            "/api/task/update/status",
                            "POST",
                            currentTaskData,
                            (error, response) => {
                                if (error) {
                                    console.error("Error for URL /api/task/update", error);
                                } else {
                                    console.log(
                                        "Response for URL /api/task/update",
                                        response
                                    );

                                }
                                currentTaskData.status = currentZone.getAttribute("id")
                            }
                        )
                    }
                }

                taskDiv.classList.remove("is-dragging");
            });
        }

        // Example of how to use the ajaxRequest function to send data with a POST request

        const todoForm = document.getElementById("todo-form");
        const input = document.getElementById("todo-input");
        const draggables = document.querySelectorAll(".task");
        const droppables = document.querySelectorAll(".swim-lane");

        const trashCanContainer = document.querySelector(
            ".trash-can-container"
        );

        todoForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const value = input.value;

            if (!value) return;

            let newTask = document.createElement("div");
            newTask.classList.add(
                "task",
                "py-1",
                "row",
                "rounded-2",
                "border-primary",
                "border-2",
                "border"
            );
            newTask.setAttribute("draggable", "true");
            newTask.setAttribute("data-bs-toggle", "modal");
            newTask.setAttribute("data-bs-target", "#task-details");

            // Create the inner content of the task
            newTask.innerHTML = `
                <div class="col-12 mb-2 lh-1 mh-50 modal-detail-title text-break">
                    ${value}
                </div>
                <div class="col d-flex justify-content-between align-items-center">
                    <img src="/images/avatars/employee_avatar.svg" class="img-fluid rounded-circle" alt="" style="width: 30px;">
                </div>
            `;

            newTask.addEventListener("dragstart", (e) => {
                newTask.classList.add("is-dragging");
                currentTask = newTask;
                console.log("dragging");
            });

            newTask.addEventListener("click", (e) => {
                modal.querySelector(".modal-title").innerText =
                    newTask.innerText;
            });

            newTask.addEventListener("dragend", () => {
                newTask.classList.remove("is-dragging");
                console.log(newTask);
                if (currentZone.classList.contains("dummy-trash")) {
                    bModal.show();
                }
                task.classList.remove("is-dragging");
            });

            todoLane.appendChild(newTask);

            input.value = "";
        });


        const comfirmBox = document.querySelector("#confirm-box");
        const bModal = new bootstrap.Modal(comfirmBox);


        comfirmBox.addEventListener("click", function (e) {
            if (e.target.innerText.toLowerCase() === "yes") {
                currentTask.remove();

                document
                    .querySelector(".trash")
                    .classList.remove("drag-over");
                bModal.hide();
                console.log("this task will be deleted", currentTask);
                sendData('/api/task/delete', "POST", currentTaskData, (error, response) => {
                    if (error) {
                        console.log("Error for Url : /api/task/delete", error)
                    } else {
                        console.log("Response for Url : /api/task/delete", response)
                    }
                })
            } else if (e.target.innerText.toLowerCase() === "no") {
                document
                    .querySelector(".trash")
                    .classList.remove("drag-over");
                bModal.hide();
            }
        });

        // ======================= TRASH BRN ======================

        if (trashCanContainer != null) {
            console.log(trashCanContainer);
            trashCanContainer.addEventListener(
                "dragover",
                function (e) {
                    e.preventDefault();
                    currentZone = trashCanContainer;
                    currentTask = document.querySelector(".is-dragging");
                    if (currentTask === null) return;
                    document
                        .querySelector(".trash")
                        .classList.add("drag-over");
                }
            );

            trashCanContainer.addEventListener(
                "dragleave",
                function (e) {
                    document
                        .querySelector(".trash")
                        .classList.remove("drag-over");
                }
            );
        }

        // =========================== TRASH BIN =============================

        // ========================== AJAX FUNCTION (JUST TESTING) ===========================

        droppables.forEach((zone) => {
            zone.addEventListener("dragover", (e) => {
                e.preventDefault();
                currentZone = zone;

                const bottomTask = insertAboveTask(zone, e.clientY);
                const curTask = document.querySelector(".is-dragging");

                if (curTask === null) {
                    return;
                }

                const curZone = zone.getAttribute("id");

                switch (curZone) {
                    case "TODO":
                        curTask.classList.add("border-primary");
                        curTask.classList.remove(
                            "border-dark",
                            "border-success"
                        );
                        break;
                    case "IN_PROGRESS":
                        curTask.classList.add("border-dark");
                        curTask.classList.remove(
                            "border-primary",
                            "border-success"
                        );
                        break;
                    case "FINISHED":
                        curTask.classList.add("border-success");
                        curTask.classList.remove(
                            "border-primary",
                            "border-dark"
                        );
                        break;
                }

                if (!bottomTask) {
                    zone.appendChild(curTask);
                } else {
                    zone.insertBefore(curTask, bottomTask);
                }
            });
        });
        const insertAboveTask = (zone, mouseY) => {
            const els = zone.querySelectorAll(
                ".task:not(.is-dragging)"
            );

            let closestTask = null;
            let closestOffset = Number.NEGATIVE_INFINITY;

            els.forEach((task) => {
                const {top} = task.getBoundingClientRect();

                const offset = mouseY - top;

                if (offset < 0 && offset > closestOffset) {
                    closestOffset = offset;
                    closestTask = task;
                }
            });

            return closestTask;
        };

        console.log("TASK LIST", taskList)

        //calendar view
        const calendarEl = document.getElementById("calendar");

        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            initialDate: new Date(),
            weekends: false,
            headerToolbar: {
                left: "prev,next today",
                center: "title",
                right: "dayGridMonth,timeGridWeek",
            },
            // loop through the taskList and add events to the calendar
            events : taskList.map((task) => {
                return {
                    title: task.title,
                    start: new Date(task.plan_start_time),
                    end: new Date(task.plan_end_time),
                    color: task.status === "TODO" ? "#007bff" : task.status === "IN_PROGRESS" ? "#6c757d" : "#28a745",
                    textColor: "white",
                    allDay: true,
                }
            })
        });

        calendar.render();

        //dynamically add bg-white class to this element .fc-view-harness
        const fcViewHarness = document.querySelector(".fc-view-harness");
        fcViewHarness.classList.add("bg-white");
        fcViewHarness.style.height = "600px";

        //dynamically change width of  .fc-col-header
        const fcColHeader = document.querySelector(".fc-col-header");
        fcColHeader.style.width = "1000px";

        const fcDayGridBody = document.querySelector(".fc-daygrid-body");
        fcDayGridBody.style.width = "1000px";

        const fcScrollgridSyncTable = document.querySelector(".fc-scrollgrid-sync-table");
        fcScrollgridSyncTable.style.width = "1000px";
        fcScrollgridSyncTable.style.height = "600px";


        //ADD TASk
        //call api/tasks/save when click add button and send data as JSON.stringify to api
        //use jquery ajax
        $("#task-add-btn").on("click", function () {
            // Get the member id for the added tag , don't return array , only id please
            const tagData = tagify.value.map((tag) => {
                const member = membersList.find((member) => {
                    return member.name + " | " + member.role === tag.value;
                });
                return member.id;
            });
            const data = {
                title: $("#title").val(),
                description: $("#description").val(),
                // Convert to Unix timestamp
                plan_start_time: new Date($("#start_time").val()).getTime(),
                plan_end_time: new Date($("#end_time").val()).getTime(),
                tasksGroup: $("#group").val(),
                projectId:
                    parseInt(projectId)
                ,
                userId: tagData[0]

            };
            console.log(data);
            $.ajax({
                url: "/api/task/save",
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json",
                success: function (response) {
                    console.log(response);
                    location.reload();
                },
                error: function (response) {
                    console.log(response);
                },
            });
        });


    </script>
</div>
</body>
</html>
