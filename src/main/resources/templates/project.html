<!DOCTYPE html>
<html
        lang="en"
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="layout/layout"
        xmlns:th="http://www.thymeleaf.org"
>
<head>
</head>

<body layout:fragment="content">
<script type="module" src="/js/callDataForTask.js" async></script>

<!-- Spinner Start -->
<div
        id="spinner"
        class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center"
>
    <div
            class="spinner-border text-primary"
            style="width: 3rem; height: 3rem"
            role="status"
    >
        <span class="sr-only">Loading...</span>
    </div>
</div>
<!-- Spinner End -->

<div th:replace="fragments/sidebar :: sidebar"></div>
<div class="container-fluid position-relative d-flex p-0">
    <!-- Content Start -->
    <div
            class="content"
            style="
                    background-color: #e5e5f7;
                    opacity: 1;
                    background-image: radial-gradient(
                        #444cf7 0.6000000000000001px,
                        #e5e5f7 0.6000000000000001px
                    );
                    background-size: 12px 12px;
                "
    >
        <div
                th:replace="fragments/navigation :: navigation-without-search"
        ></div>

        <div class="container-fluid mt-2">
            <!-- nav for task and gantt chart start -->
            <nav>
                <ul
                        class="nav nav-tabs rounded-top"
                        id="myTab"
                        role="tablist"
                >
                    <li class="nav-item" role="presentation">
                        <button
                                class="nav-link active border-primary border border-bottom-0"
                                id="tasks-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#task"
                                type="button"
                                role="tab"
                                aria-controls="task"
                                aria-selected="false"
                        >
                            Tasks
                            <p style="display:none;" th:text="${projectId}" id="projectId"></p>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button
                                class="nav-link border-primary border border-bottom-0 rounded-top"
                                id="gantt-chart-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#gantt-chart"
                                type="button"
                                role="tab"
                                aria-controls="gantt-chart"
                                aria-selected="false"
                        >
                            Calendar
                        </button>
                    </li>
                </ul>
            </nav>
            <!-- nav for task and gantt chart end -->
            <div
                    class="tab-content position-relative"
                    style="height: 600px"
                    id="myTabContent"
            >
                <div
                        class="d-flex justify-content-end trash-can-container dummy-trash position-absolute"
                        style="bottom: 100px; right: 0; width: 60px"
                >
                            <span class="trash align-self-end dummy-trash">
                                <span class="dummy-trash"></span>
                            </span>
                </div>
                <div
                        class="tab-pane fade show active"
                        id="task"
                        role="tabpanel"
                        aria-labelledby="tasks-tab"
                >
                    <div class="board">
                        <!-- add task form start -->
                        <!-- add task form end -->

                        <div class="lanes" id="sort-container">
                            <div class="lane">
                                <h3
                                        class="heading bg-primary text-white rounded-top p-2 d-flex justify-content-between align-items-center"
                                >
                                    TODO
                                    <button
                                            type="submit"
                                            class="btn btn-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#add-task"
                                    >
                                        <i
                                                class="bi bi-plus-circle"
                                        ></i>
                                    </button>
                                </h3>
                                <div class="swim-lane p-3" id="TODO">
                                </div>
                                <div
                                        class="bg-primary rounded-bottom"
                                        style="height: 10px"
                                ></div>
                            </div>
                            <!-- todo end -->
                            <!-- doing start -->
                            <div class="lane">
                                <h3
                                        class="heading bg-info text-white rounded-top p-2"
                                >
                                    DOING
                                </h3>
                                <div
                                        class="swim-lane p-3"
                                        id="IN_PROGRESS"
                                >
                                </div>
                                <div
                                        class="bg-info rounded-bottom"
                                        style="height: 10px"
                                ></div>
                            </div>
                            <!-- doing end -->
                            <!-- done start -->
                            <div class="lane">
                                <h3
                                        class="heading bg-success text-white rounded-top p-2"
                                >
                                    DONE
                                </h3>
                                <div
                                        class="swim-lane p-3"
                                        id="FINISHED"
                                ></div>
                                <div
                                        class="bg-success rounded-bottom"
                                        style="height: 10px"
                                ></div>
                            </div>
                            <!-- done end -->
                        </div>
                    </div>
                </div>
                <!-- calendar start -->
                <div
                        class="tab-pane fade mt-5"
                        id="gantt-chart"
                        role="tabpanel"
                        aria-labelledby="gantt-chart-tab"
                >
                    <div class="toolbar mb-4">
                        <button id="previous" class="btn btn-success">Previous</button>
                        <button id="today" class="btn btn-primary">Today</button>
                        <button id="next" class="btn btn-success">Next</button>
                    </div>
                    <div id="calendar" class="border border-dark"></div>
                </div>

                <!-- calendar end -->
            </div>
        </div>
    </div>
    <!-- Content End -->

    <!-- task's details start -->
    <div class="modal fade" id="task-details" data-bs-keyboard="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content task-content">
                <div class="modal-header">
                    <h2 class="card-title" style="text-align: center">
                        Task Details
                    </h2>
                    <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body">
                    <form class="row g-5" action="">
                        <div class="col-lg-6">
                            <span><i class="fa fa-tasks"></i></span>
                            <label
                                    class="editable-label"
                                    for="taskTitle"
                                    onclick="editTitle()"
                            >
                                Task Title</label
                            >
                            <input
                                    id="taskTitle"
                                    name="task"
                                    type="text"
                                    class="form-control border-task editable-input"
                                    dir="auto"
                                    data-autosize="true"
                                    style="
                                            overflow: hidden;
                                            overflow-wrap: break-word;
                                            height: 37px;
                                        "
                                    onblur="updateTitle(this)"
                                    disabled
                            />
                        </div>

                        <div class="col-lg-6">
                                    <span
                                    ><i
                                            class="fa-solid fa-bars-staggered"
                                    ></i
                                    ></span>
                            <label
                                    id="description-label"
                                    class="editable-label"
                                    onclick="toggleEditor()"
                            >
                                Description</label
                            >
                            <textarea
                                    id="description-editor"
                                    class="form-control editable-input"
                                    name="description"
                                    row
                                    disabled
                            ></textarea>
                        </div>

                        <div class="col-lg-6">
                                    <span>
                                        <i class="fa-solid fa-users"></i>
                                    </span>
                            <span
                                    class="badge rounded-pill bg-info"
                                    id="assigned-member"
                            ></span>
                        </div>

                        <div class="col-lg-6">
                                    <span>
                                        <i
                                                class="fa-solid fa-circle-chevron-down"
                                        ></i>
                                        Status
                                    </span>
                            <span class='badge rounded-pill  bg-primary' id="status"></span>
                        </div>

                        <div class="col-lg-6">
                            <i class="fa-regular fa-calendar"></i>
                            <label
                                    id="duration"
                                    class="editable-label"
                                    onclick="editTitle()"
                            >
                                Duration</label
                            >
                            <input
                                    type="text"
                                    id="tduration"
                                    name="task"
                                    class="form-control border-task editable-input"
                                    dir="auto"
                                    data-autosize="true"
                                    style="
                                            overflow: hidden;
                                            overflow-wrap: break-word;
                                            height: 37px;

                                        "
                                    onblur="updateTitle(this)"
                                    disabled
                            />
                        </div>

                        <div class="col-lg-6">
                                    <span
                                    ><i
                                            class="fa-solid fa-calendar-days"
                                    ></i
                                    ></span>
                            <label
                                    class="editable-label"
                                    onclick="editTitle()"
                            >
                                Start Date</label
                            >
                            <input
                                    type="date"
                                    id="task-detail-start_time"
                                    name="start_time"
                                    class="form-control border-task editable-input"
                                    dir="auto"
                                    data-autosize="true"
                                    style="
                                            overflow: hidden;
                                            overflow-wrap: break-word;
                                            height: 37px;
                                        "
                                    onblur="updateTitle(this)"
                            />
                        </div>






                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- task's details end -->

    <!-- add task -->
    <div class="modal fade" data-bs-keyboard="true" id="add-task">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content task-content">
                <div class="modal-header">
                    <h2 class="card-title" style="text-align: center">
                        Add Task
                    </h2>
                    <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3" id="todo-form">
                        <div class="col-12">
                            <label
                                    for="title"
                                    class="col-sm-12 col-form-label"
                            >Task Title <span
                                    style="color:red"> *</span></label
                            >
                            <input
                                    type="text"
                                    class="form-control border-task-title"
                                    id="title"
                                    name="title"
                                    rows="2"
                            ></input>
                        </div>

                        <div class="col-12">
                            <label
                                    for="description"
                                    class="col-sm-12 col-form-label"
                            >Description <span
                                    style="color:red"> *</span></label
                            >
                            <textarea
                                    class="form-control border-task-description"
                                    id="description"
                                    name="description"
                                    rows="2"
                            ></textarea>
                        </div>

                        <div class="col-lg-6">
                            <label
                                    for="member"
                                    class="col-sm-12 col-form-label"
                            >Assign Members<span style="color: red">
                                            *</span
                            ></label
                            >
                            <input
                                    type="text"
                                    name="member-tags"
                                    id="member"
                                    placeholder="Select An Employee"
                            />
                        </div>
                        <div class="col-lg-6">
                            <label for="group" class="col-sm-12 col-form-label">Group <span
                                    style="color:red"> *</span></label>
                            <select class="form-control" aria-label="Select Group" data-live-search="true"
                                    id="group" name="group">
                                <option value="A">A - Related With Project Development</option>
                                <option value="B">B - Training</option>
                                <option value="C">C - Idling</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label
                                    for="start_time"
                                    class="col-sm-12 col-form-label"
                            >Start Date
                                <span style="color: red">
                                            *</span
                                ></label
                            >
                            <input
                                    type="date"
                                    class="form-control border-task-description"
                                    id="start_time"
                                    name="start_time"
                            />
                        </div>

                        <div class="col-md-6">
                            <label
                                    for="end_time"
                                    class="col-sm-12 col-form-label"
                            >End Date
                                <span style="color: red">
                                            *</span
                                ></label
                            >
                            <input
                                    type="date"
                                    class="form-control border-task-description"
                                    id="end_time"
                                    name="end_time"
                            />
                        </div>


                        <div class="text-center mt-3">
                            <button
                                    type="submit"
                                    class="btn btn-primary col-2"
                                    data-dismiss="modal"
                                    id="task-add-btn"
                            >
                                Add
                            </button>
                            <button
                                    type="reset"
                                    class="btn btn-secondary mr-3"
                                    data-dismiss="modal"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- add task -->

    <!-- confrim box for delete -->
    <div
            class="modal fade"
            id="confirm-box"
            data-bs-keyboard="false"
            data-bs-backdrop="static"
    >
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <span>Are you sure you want to delete ?</span>
                    <button class="btn btn-danger col me-1">YES</button>
                    <button class="btn btn-primary col" data-bs-dismiss="modal" aria-label="Close">NO</button>
                </div>
            </div>
        </div>
    </div>
    <!-- confirm box for delete -->

    <!--    for select drop-drown-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>

    <!-- fontawesome -->
    <script src="/js/fontawesome.js"></script>

    <!-- jquery -->
    <script src="/js/jquery.3.7.1.min.js"></script>

    <!-- datable table -->
    <script src="/js/databales.min.js"></script>

    <!-- bootstrap -->
    <script src="/js/bootstrap.bundle.min.js"></script>

    <!-- javascript libraries -->
    <script src="/lib/chart/chart.min.js"></script>
    <script src="/lib/easing/easing.min.js"></script>
    <script src="/lib/waypoints/waypoints.min.js"></script>
    <script src="/lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="/lib/tempusdominus/js/moment.min.js"></script>
    <script src="/lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="/lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>
    <script src="/lib/quill/quill.min.js"></script>

    <!-- toast ui calendar -->
    <script src="https://uicdn.toast.com/tui.code-snippet/latest/tui-code-snippet.js"></script>
    <script src="https://uicdn.toast.com/tui.dom/v3.0.0/tui-dom.js"></script>
    <script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.min.js"></script>
    <script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.js"></script>
    <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script>

    <!-- Template Javascript -->
    <script src="/js/main.js"></script>
    <script src="/js/forprogresscircleiguess.js"></script>

    <!-- sort (department, project), form validation and search bar behavior are all here -->
    <script src="/js/custome.js"></script>

    <!--    for assign member-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tagify/4.2.0/tagify.min.js"></script>

    <script type="module">
        import {getData, sendData} from "/js/api-function.js";
        import {getTaskList} from '/js/callDataForTask.js';

        // Get the project ID from the hidden element
        const projectId = document.getElementById("projectId").innerText;

        // Function to fetch the members' list from the backend API
        var membersList;
        $.ajax({
            url: "/api/user/list/projectId/" + projectId,
            type: "GET",
            async: false,
            success: function (data) {
                membersList = data;
            },
        });
        console.log("MEMBERS LIST" , membersList);

        var memberInputTag = document.querySelector('input[name=member-tags]'),
            tagify = new Tagify(memberInputTag, {
                enforceWhitelist: true,
                mode : "select",
                whitelist:  membersList.map((member) => {
                    return member.name + " | " + member.role;
                }),
                blacklist: ['foo', 'bar'],
            })

        // tagify.settings.templates =

        // bind events
        tagify.on('add', onAddTag)
        tagify.DOM.input.addEventListener('focus', onSelectFocus)

        function onAddTag(e){

            console.log(e.detail);

        }

        function onSelectFocus(e){
            console.log(e)
        }

        // Get all elements with the common class name
        const editableLabels =
            document.querySelectorAll(".editable-label");
        const editableInputs =
            document.querySelectorAll(".editable-input");

        // Add event listeners for each element
        editableLabels.forEach((label) => {
            label.addEventListener("click", editTitle);
        });

        editableInputs.forEach((input) => {
            input.addEventListener("blur", function () {
                updateTitle(this);
            });
        });

        function editTitle() {
            const label = this;
            const input = label.nextElementSibling;

            //remove disabled attribute to enable editing
            input.removeAttribute("disabled");
            input.focus();
        }

        function updateTitle(inputField) {
            //add disabled attribute to disable editing
            inputField.setAttribute("disabled", true);
        }

        function toggleEditor() {
            var editor = document.getElementById("description-editor");
            if (
                editor.style.display === "none" ||
                editor.style.display === ""
            ) {
                editor.style.display = "block";
            } else {
                editor.style.display = "none";
            }
        }

        const todoLane = document.getElementById("TODO");
        const inProgress = document.getElementById("IN_PROGRESS");
        const finished = document.getElementById("FINISHED");
        let currentZone = null;
        let currentTask;
        let currentTaskData;
        const status = ['TODO', 'IN_PROGRESS', 'FINISHED']
        const modal = document.getElementById("task-details");

        function createTaskDiv(task) {
            const taskDiv = document.createElement("div");
            taskDiv.classList.add(
                "task",
                "py-1",
                "row",
                "rounded-2",
                "border-2",
                "border"
            );
            switch (task.status) {
                case "TODO":
                    taskDiv.classList.add("border-primary");
                    break;
                case "IN_PROGRESS":
                    taskDiv.classList.add("border-dark");
                    break;
                case "FINISHED":
                    taskDiv.classList.add("border-success");
                    break;
            }
            taskDiv.draggable = true;

            // Add a data attribute for modal triggering (if needed)
            taskDiv.setAttribute("data-bs-toggle", "modal");
            taskDiv.setAttribute("data-bs-target", "#task-details");

            const titleDiv = document.createElement("div");
            titleDiv.classList.add(
                "col-12",
                "mb-2",
                "lh-1",
                "mh-50",
                "modal-detail-title",
                "text-break"
            );
            titleDiv.textContent = task.title;

            const imgDiv = document.createElement("div");
            imgDiv.classList.add(
                "col",
                "d-flex",
                "justify-content-between",
                "align-items-center"
            );

            const img = document.createElement("img");
            img.src =
                "/images/avatars/employee_avatar.svg"; // Assuming you want to change the image based on task.id
            img.classList.add("img-fluid", "rounded-circle");
            img.alt = "";
            img.style.width = "30px";

            imgDiv.appendChild(img);

            taskDiv.appendChild(titleDiv);
            taskDiv.appendChild(imgDiv);

            return taskDiv;
        }

        let taskList = await getTaskList()

        for (let i = 0; i < taskList.length; i++) {
            const task = taskList[i];

            const taskDiv = createTaskDiv(task);

            taskDiv.setAttribute("index", i);

            // Determine the status of the task and append it to the appropriate lane
            if (task.status === "TODO") {
                todoLane.appendChild(taskDiv);
            } else if (task.status === "IN_PROGRESS") {
                inProgress.appendChild(taskDiv);
            } else if (task.status === "FINISHED") {
                finished.appendChild(taskDiv);
            }
            taskDiv.addEventListener("dragstart", (e) => {
                taskDiv.classList.add("is-dragging");
                currentZone = taskDiv.parentElement;
                console.log("dragging");
                currentTask = taskDiv;
                console.log("CURRENT TASK ", currentTask)
            });

            taskDiv.addEventListener("click", (e) => {

                currentTaskData = taskList[parseInt(taskDiv.getAttribute('index'))]
                console.log('click task so should change the current task data', currentTaskData)
                //change input value from that taskdata
                document.getElementById('taskTitle').value = currentTaskData.title
                document.getElementById('description-editor').value = currentTaskData.description
                // document.getElementById('tduration').value = currentTaskData.duration
                // document.getElementById('task-detail-start_time').value = currentTaskData.start_time

                // change status span text according to the status and also change badge color
                if (currentTaskData.status === 'TODO') {
                    document.getElementById('status').innerText = 'TODO'
                    document.getElementById('status').classList.remove('bg-info', 'bg-success')
                    document.getElementById('status').classList.add('bg-primary')
                } else if (currentTaskData.status === 'IN_PROGRESS') {
                    document.getElementById('status').innerText = 'IN_PROGRESS'
                    document.getElementById('status').classList.remove('bg-primary', 'bg-success')
                    document.getElementById('status').classList.add('bg-warning')
                } else if (currentTaskData.status === 'FINISHED') {
                    document.getElementById('status').innerText = 'FINISHED'
                    document.getElementById('status').classList.remove('bg-primary', 'bg-info')
                    document.getElementById('status').classList.add('bg-success')
                }

                // change the assigned member span value
                document.getElementById('assigned-member').innerText = currentTaskData.userDto.name + " | " + currentTaskData.userDto.role

            });

            taskDiv.addEventListener("dragend", () => {
                taskDiv.classList.remove("is-dragging");
                currentTaskData =
                    taskList[
                        parseInt(currentTask.getAttribute("index"))
                        ];
                console.log("CURRENT TASK DATA", currentTaskData)
                if (currentZone.classList.contains("dummy-trash")) {
                    bModal.show();
                } else if (status.some(a => currentZone.getAttribute("id") === a)) {
                    console.log("the task indeed drop on the one of the three zone")
                    console.log(currentTaskData.status, currentZone.getAttribute("id"))
                    if (currentTaskData.status !== currentZone.getAttribute("id")) {
                        sendData(
                            "/api/task/update",
                            "POST",
                            currentTaskData,
                            (error, response) => {
                                if (error) {
                                    console.error("Error for URL /api/task/update", error);
                                } else {
                                    console.log(
                                        "Response for URL /api/task/update",
                                        response
                                    );

                                }
                                currentTaskData.status = currentZone.getAttribute("id")
                            }
                        )
                    }
                }

                taskDiv.classList.remove("is-dragging");
            });
        }

        // Example of how to use the ajaxRequest function to send data with a POST request

        const todoForm = document.getElementById("todo-form");
        const input = document.getElementById("todo-input");
        const draggables = document.querySelectorAll(".task");
        const droppables = document.querySelectorAll(".swim-lane");

        const trashCanContainer = document.querySelector(
            ".trash-can-container"
        );

        todoForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const value = input.value;

            if (!value) return;

            let newTask = document.createElement("div");
            newTask.classList.add(
                "task",
                "py-1",
                "row",
                "rounded-2",
                "border-primary",
                "border-2",
                "border"
            );
            newTask.setAttribute("draggable", "true");
            newTask.setAttribute("data-bs-toggle", "modal");
            newTask.setAttribute("data-bs-target", "#task-details");

            // Create the inner content of the task
            newTask.innerHTML = `
                <div class="col-12 mb-2 lh-1 mh-50 modal-detail-title text-break">
                    ${value}
                </div>
                <div class="col d-flex justify-content-between align-items-center">
                    <img src="/images/avatars/employee_avatar.svg" class="img-fluid rounded-circle" alt="" style="width: 30px;">
                </div>
            `;

            newTask.addEventListener("dragstart", (e) => {
                newTask.classList.add("is-dragging");
                currentTask = newTask;
                console.log("dragging");
            });

            newTask.addEventListener("click", (e) => {
                modal.querySelector(".modal-title").innerText =
                    newTask.innerText;
            });

            newTask.addEventListener("dragend", () => {
                newTask.classList.remove("is-dragging");
                console.log(newTask);
                if (currentZone.classList.contains("dummy-trash")) {
                    bModal.show();
                }
                task.classList.remove("is-dragging");
            });

            todoLane.appendChild(newTask);

            input.value = "";
        });


        const comfirmBox = document.querySelector("#confirm-box");
        const bModal = new bootstrap.Modal(comfirmBox);


        comfirmBox.addEventListener("click", function (e) {
            if (e.target.innerText.toLowerCase() === "yes") {
                currentTask.remove();

                document
                    .querySelector(".trash")
                    .classList.remove("drag-over");
                bModal.hide();
                console.log("this task will be deleted", currentTask);
                sendData('/api/task/delete', "POST", currentTaskData, (error, response) => {
                    if (error) {
                        console.log("Error for Url : /api/task/delete", error)
                    } else {
                        console.log("Response for Url : /api/task/delete", response)
                    }
                })
            } else if (e.target.innerText.toLowerCase() === "no") {
                document
                    .querySelector(".trash")
                    .classList.remove("drag-over");
                bModal.hide();
            }
        });

        // ======================= TRASH BRN ======================

        if (trashCanContainer != null) {
            console.log(trashCanContainer);
            trashCanContainer.addEventListener(
                "dragover",
                function (e) {
                    e.preventDefault();
                    currentZone = trashCanContainer;
                    currentTask = document.querySelector(".is-dragging");
                    if (currentTask === null) return;
                    document
                        .querySelector(".trash")
                        .classList.add("drag-over");
                }
            );

            trashCanContainer.addEventListener(
                "dragleave",
                function (e) {
                    document
                        .querySelector(".trash")
                        .classList.remove("drag-over");
                }
            );
        }

        // =========================== TRASH BIN =============================

        // ========================== AJAX FUNCTION (JUST TESTING) ===========================

        droppables.forEach((zone) => {
            zone.addEventListener("dragover", (e) => {
                e.preventDefault();
                currentZone = zone;

                const bottomTask = insertAboveTask(zone, e.clientY);
                const curTask = document.querySelector(".is-dragging");

                if (curTask === null) {
                    return;
                }

                const curZone = zone.getAttribute("id");

                switch (curZone) {
                    case "TODO":
                        curTask.classList.add("border-primary");
                        curTask.classList.remove(
                            "border-dark",
                            "border-success"
                        );
                        break;
                    case "IN_PROGRESS":
                        curTask.classList.add("border-dark");
                        curTask.classList.remove(
                            "border-primary",
                            "border-success"
                        );
                        break;
                    case "FINISHED":
                        curTask.classList.add("border-success");
                        curTask.classList.remove(
                            "border-primary",
                            "border-dark"
                        );
                        break;
                }

                if (!bottomTask) {
                    zone.appendChild(curTask);
                } else {
                    zone.insertBefore(curTask, bottomTask);
                }
            });
        });
        const insertAboveTask = (zone, mouseY) => {
            const els = zone.querySelectorAll(
                ".task:not(.is-dragging)"
            );

            let closestTask = null;
            let closestOffset = Number.NEGATIVE_INFINITY;

            els.forEach((task) => {
                const {top} = task.getBoundingClientRect();

                const offset = mouseY - top;

                if (offset < 0 && offset > closestOffset) {
                    closestOffset = offset;
                    closestTask = task;
                }
            });

            return closestTask;
        };

        // ========================== Calendar View ===========================
        const Calendar = tui.Calendar;

        const calendar = new Calendar("#calendar", {
            defaultView: "week",
            taskView: true,
            useDetailPopup: true,
            isReadOnly: true,
            template: {
                monthDayname: function (dayname) {
                    return (
                        "<span class='calendar-week-dayname-name'>" + dayname.label + "</span>"
                    );
                },
                timegridCurrentTime: function () {
                    return "<span class='calendar-icon ic-time'></span> Current Time";
                },
                timegridNowIndicatorLabel: function (time) {
                    return time.hour + ":" + time.minutes;
                },
            },

        });

        $("#previous").on("click", function () {
            calendar.prev();
        });

        $("#next").on("click", function () {
            calendar.next();
        });

        $("#today").on("click", function () {
            calendar.today();
        });

        calendar.setOptions({
            week: {
                daynames: ["Mon", "Tue", "Wed", "Thu", "Fri"],
                startDayOfWeek: 0,
                workweek: true,
                //set 12 hour format
                hourStart: 7,
                hourEnd: 19,
            },
        });
        console.log(calendar.getOptions().template)

        calendar.createEvents([
            {
                id: "1",
                calendarId: "1",
                title: "my schedule",
                category: "time",
                dueDateClass: "",
                start: "2023-11-06T10:30:00+06:30",
                end: "2023-11-06T14:30:00+06:30",
                isReadOnly: true, // schedule is read-only
            },
            {
                id: "2",
                calendarId: "1",
                title: "second schedule",
                category: "time",
                dueDateClass: "",
                start: "2023-11-06T09:30:00+06:30",
                end: "2023-11-07T17:30:00+06:30",
                isReadOnly: true, // schedule is read-only
            },
        ]);


        //ADD TASk
        //call api/tasks/save when click add button and send data as JSON.stringify to api
        //use jquery ajax
        $("#task-add-btn").on("click", function () {
            // Get the member id for the added tag , don't return array , only id please
            const tagData = tagify.value.map((tag) => {
                const member = membersList.find((member) => {
                    return member.name + " | " + member.role === tag.value;
                });
                return member.id;
            });
            const data = {
                title: $("#title").val(),
                description: $("#description").val(),
                // Convert to Unix timestamp
                plan_start_time: new Date($("#start_time").val()).getTime(),
                plan_end_time: new Date($("#end_time").val()).getTime(),
                tasksGroup: $("#group").val(),
                projectDto: {
                    id: parseInt(projectId)
                },
                userDto: {
                    id: tagData[0]
                }
            };
            console.log(data);
            $.ajax({
                url: "/api/task/save",
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json",
                success: function (response) {
                    console.log(response);
                    location.reload();
                },
                error: function (response) {
                    console.log(response);
                },
            });
        });


    </script>
</div>
</body>
</html>
